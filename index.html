<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <meta name="description" content="记录技术点滴">
  
  <title>
    
    个人博客
  </title>
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <main class="content">
    <section class="jumbotron">
  <div class="video">
    
    <div class="video-frame">
      <img src="/images/ocean/overlay-hero.png" alt="Decorative image frame">
    </div>
    
    <div class="video-media">
      <video playsinline="" autoplay="" loop="" muted="" data-autoplay="" poster="/images/ocean/ocean.png"
        x5-video-player-type="h5">
        <source src="/images/ocean/ocean.mp4" type="video/mp4">
        <source src="/images/ocean/ocean.ogv" type="video/ogg">
        <source src="/images/ocean/ocean.webm" type="video/webm">
        <p>Your user agent does not support the HTML5 Video element.</p>
      </video>
      <div class="video-overlay"></div>
    </div>
    <div class="video-inner text-center text-white">
      <h1><a href="/">个人博客</a></h1>
      <p>博客</p>
      <div><img src="/images/hexo-inverted.svg" class="brand" alt="个人博客"></div>
    </div>
    <div class="video-learn-more">
      <a class="anchor" href="#landingpage"><i class="fe fe-mouse"></i></a>
    </div>
  </div>
</section>
<div id="landingpage">
  <section class="outer">
  <article class="articles">
    
    <h1 class="page-type-title"></h1>
    
    
    <article id="post-Flink新特性-CDC" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2021/11/07/Flink%E6%96%B0%E7%89%B9%E6%80%A7-CDC/">Flink新特性-CDC</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2021/11/07/Flink%E6%96%B0%E7%89%B9%E6%80%A7-CDC/" class="article-date">
  <time datetime="2021-11-07T08:33:00.000Z" itemprop="datePublished">2021-11-07</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
      <h4 id="1-1-CDC简介"><a href="#1-1-CDC简介" class="headerlink" title="1.1.CDC简介"></a>1.1.CDC简介</h4><p>官网<br><a target="_blank" rel="noopener" href="https://github.com/ververica/flink-cdc-connectors">https://github.com/ververica/flink-cdc-connectors</a></p>
<h5 id="1-1-1-什么是-CDC"><a href="#1-1-1-什么是-CDC" class="headerlink" title="1.1.1.什么是 CDC"></a>1.1.1.什么是 CDC</h5><p>CDC是 Change Data Capture 变更数据获取 的简称。 核心思想是，监测并捕获数据库的变动（包括数据或数据表的插入 更新 以及 删除等），将这些变更按发生的顺序完整记录下来，写入到消息中间件中以供其他服务进行订阅及消费。</p>
<h5 id="1-1-2-CDC的种类"><a href="#1-1-2-CDC的种类" class="headerlink" title="1.1.2.CDC的种类"></a>1.1.2.CDC的种类</h5><p><img src="/img/cnd-01.png" alt="upload successful"></p>
<h5 id="1-1-3-Flink-CDC"><a href="#1-1-3-Flink-CDC" class="headerlink" title="1.1.3.Flink-CDC"></a>1.1.3.Flink-CDC</h5><p>Flink社区开发了 flink-cdc-connectors 组件，这是一个可以直接从MySQL、PostgreSQL等数据库直接读取全量数据和 增量变更数据 的 source 组件。</p>
<p>目前也已开源，开源地址：<br><a target="_blank" rel="noopener" href="https://github.com/ververica/flink-cdc-connectors">https://github.com/ververica/flink-cdc-connectors</a></p>
<h4 id="1-2-Flink-CDC案例实操"><a href="#1-2-Flink-CDC案例实操" class="headerlink" title="1.2.Flink CDC案例实操"></a>1.2.Flink CDC案例实操</h4><h5 id="1-2-1-DataStream方式的应用"><a href="#1-2-1-DataStream方式的应用" class="headerlink" title="1.2.1.DataStream方式的应用"></a>1.2.1.DataStream方式的应用</h5><h6 id="1-2-1-0-创建测试数据"><a href="#1-2-1-0-创建测试数据" class="headerlink" title="1.2.1.0.创建测试数据"></a>1.2.1.0.创建测试数据</h6><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `student`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `student` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `age` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `student` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;zhanggan&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `student` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;lisi&#x27;</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `student` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;wangwu&#x27;</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h6 id="1-2-1-1-导入依赖"><a href="#1-2-1-1-导入依赖" class="headerlink" title="1.2.1.1.导入依赖"></a>1.2.1.1.导入依赖</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-java_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-clients_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.49<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-table-planner-blink_2.12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.12.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ververica<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-mysql-cdc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.75<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                               <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                           <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                       <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                   <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="1-2-1-2-编写代码"><a href="#1-2-1-2-编写代码" class="headerlink" title="1.2.1.2.编写代码"></a>1.2.1.2.编写代码</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.cdc;</span><br><span class="line"><span class="keyword">import</span> com.ververica.cdc.connectors.mysql.MySqlSource;</span><br><span class="line"><span class="keyword">import</span> com.ververica.cdc.connectors.mysql.table.StartupOptions;</span><br><span class="line"><span class="keyword">import</span> com.ververica.cdc.debezium.StringDebeziumDeserializationSchema;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.restartstrategy.RestartStrategies;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.runtime.state.filesystem.FsStateBackend;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.CheckpointingMode;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStreamSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.CheckpointConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.source.SourceFunction;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlinkCDC</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//1.创建执行环境</span></span><br><span class="line">        StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        env.setParallelism(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//2.Flink-CDC将读取 binlog的位置信息以状态的方式保存在 CK,如果想要做到断点</span></span><br><span class="line">        <span class="comment">//续传, 需要从 Checkpoint或者 Savepoint启动程序</span></span><br><span class="line"><span class="comment">//2.1 开启 Checkpoint,每隔 5秒钟做一次 CK</span></span><br><span class="line">        env.enableCheckpointing(<span class="number">5000L</span>);</span><br><span class="line"><span class="comment">// 2.2 指定 CK的一致性语义</span></span><br><span class="line">        env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line">        <span class="comment">//2.3 设置任务关闭的时候保留最后一次 CK数据</span></span><br><span class="line">        env.getCheckpointConfig().enableExternalizedCheckpoints(CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION);</span><br><span class="line">        <span class="comment">//2.4 指定从 CK自动重启策略</span></span><br><span class="line">        env.setRestartStrategy(RestartStrategies.fixedDelayRestart(<span class="number">3</span>, <span class="number">2000L</span>));</span><br><span class="line">        <span class="comment">//2.5 设置状态后端</span></span><br><span class="line">        env.setStateBackend(<span class="keyword">new</span> FsStateBackend(<span class="string">&quot;file:///Users/tmp&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.6 设置访问 HDFS的用户名</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;HADOOP_USER_NAME&quot;</span>, <span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="comment">//3.创建 Flink-MySQL-CDC的 Source //initial (default): Performs an initial snapshot on the monitored database tables upon first startup, and continue to read the latest binlog. //latest-offset: Never to perform snapshot on the monitored database tables upon first startup, just read from the end of the binlog which means only have the changes since the connector was started. //timestamp: Never to perform snapshot on the monitored database tables upon first startup, and directly read binlog from the specified timestamp. The consumer will traverse the binlog from the beginning and ignore change events whose timestamp is smaller than the specified timestamp. //specific-offset: Never to perform snapshot on the monitored database tables upon first startup, and directly read binlog from the specified offset.</span></span><br><span class="line"></span><br><span class="line">        SourceFunction&lt;String&gt; sourceFunction = MySqlSource.&lt;String&gt;builder()</span><br><span class="line">                .hostname(<span class="string">&quot;hadoop001&quot;</span>)</span><br><span class="line">                .port(<span class="number">3306</span>)</span><br><span class="line">                .databaseList(<span class="string">&quot;Test-1&quot;</span>) <span class="comment">// set captured database</span></span><br><span class="line"><span class="comment">//                .tableList(&quot;yourDatabaseName.yourTableName&quot;) // set captured table</span></span><br><span class="line">                .username(<span class="string">&quot;root&quot;</span>)</span><br><span class="line">                .password(<span class="string">&quot;hadoop123456&quot;</span>)</span><br><span class="line">                .deserializer(<span class="keyword">new</span> StringDebeziumDeserializationSchema()) <span class="comment">// converts SourceRecord to String</span></span><br><span class="line"><span class="comment">//                .debeziumProperties(debeziumProperties)</span></span><br><span class="line">                .startupOptions(StartupOptions.initial())</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.使用 CDC Source从 MySQL读取数据</span></span><br><span class="line">        DataStreamSource&lt;String&gt; mysqlDS = env.addSource(sourceFunction); <span class="comment">//5.打印数据</span></span><br><span class="line">        mysqlDS.print(); <span class="comment">//6.执行任务</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h6 id="1-2-1-3-测试"><a href="#1-2-1-3-测试" class="headerlink" title="1.2.1.3.测试"></a>1.2.1.3.测试</h6><h5 id="1-2-2-FlinkSQL方式的应用"><a href="#1-2-2-FlinkSQL方式的应用" class="headerlink" title="1.2.2.FlinkSQL方式的应用"></a>1.2.2.FlinkSQL方式的应用</h5><h6 id="1-2-2-1-导入依赖"><a href="#1-2-2-1-导入依赖" class="headerlink" title="1.2.2.1.导入依赖"></a>1.2.2.1.导入依赖</h6>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/11/07/Flink%E6%96%B0%E7%89%B9%E6%80%A7-CDC/" data-id="ckw5znxwa0004w9gh0pd4at3c" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-git使用" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2020/11/19/git%E4%BD%BF%E7%94%A8/">git使用</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2020/11/19/git%E4%BD%BF%E7%94%A8/" class="article-date">
  <time datetime="2020-11-19T01:40:00.000Z" itemprop="datePublished">2020-11-19</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
      <h3 id="0-github和码云与本地git同步"><a href="#0-github和码云与本地git同步" class="headerlink" title="0.github和码云与本地git同步"></a>0.github和码云与本地git同步</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">通过命令git init把这个文件夹变成Git可管理的仓库</span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line">git status</span><br><span class="line">git add .</span><br><span class="line">git commit -m &quot;first commit&quot;</span><br><span class="line"></span><br><span class="line">关联github</span><br><span class="line">git remote add github git@github.com:xxx&#x2F;EducationWebsiteSparkStreamingCode.git</span><br><span class="line"></span><br><span class="line">提交到gitHub</span><br><span class="line">git push -u github master</span><br><span class="line"></span><br><span class="line">关联码云</span><br><span class="line">git remote add gitee https:&#x2F;&#x2F;gitee.com&#x2F;xxx&#x2F;EducationWebsiteSparkStreamingCode.git</span><br><span class="line"></span><br><span class="line">提交到码云</span><br><span class="line"> git push -u gitee master</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.进入到推送的项目的.git文件夹下</span><br><span class="line"></span><br><span class="line">查看已经连接的远程仓库</span><br><span class="line">git remote -v</span><br><span class="line"></span><br><span class="line">先删除已关联的名为origin的远程库</span><br><span class="line">git remote rm origin</span><br><span class="line"></span><br><span class="line">使用多个远程库时，要注意git给远程库起的默认名称是origin，</span><br><span class="line">如果有多个远程库，我们需要用不同的名称来标识不同的远程库。</span><br><span class="line">仍然以learngit本地库为例，</span><br><span class="line"></span><br><span class="line">先删除已关联的名为origin的远程库：</span><br><span class="line">git remote rm origin</span><br><span class="line"></span><br><span class="line">然后，先关联GitHub的远程库：(项目后的ssh地址)</span><br><span class="line">git remote add github git@github.com:xxx&#x2F;LearnGit.git</span><br><span class="line">注意，远程库的名称叫github，不叫origin了。</span><br><span class="line"></span><br><span class="line">接着，再关联码云的远程库：</span><br><span class="line">git remote add gitee git@gitee.com:xxx&#x2F;LearnGit.git</span><br><span class="line"></span><br><span class="line">同样注意，远程库的名称叫gitee，不叫origin。</span><br><span class="line">现在，我们用git remote -v查看远程库信息，可以看到两个远程库：</span><br><span class="line"></span><br><span class="line">gitee   git@gitee.com:xxx&#x2F;LearnGit.git (fetch)</span><br><span class="line">gitee   git@gitee.com:xxx&#x2F;LearnGit.git (push)</span><br><span class="line">github  git@github.com:xxx&#x2F;LearnGit.git (fetch)</span><br><span class="line">github  git@github.com:xxx&#x2F;LearnGit.git (push)</span><br><span class="line"></span><br><span class="line">添加代码到本地仓库</span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line">提交并添加描述</span><br><span class="line">git commit -m &quot;first commit&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">如果要推送到GitHub，使用命令：</span><br><span class="line">git push github master(分支)</span><br><span class="line">如果要推送到码云，使用命令：</span><br><span class="line">git push gitee master(分支)</span><br><span class="line">这样一来，本地库就可以同时与多个远程库互相同步</span><br><span class="line"></span><br><span class="line">---------------------------------------------------------------------</span><br><span class="line">创建分支</span><br><span class="line">git branch develop</span><br><span class="line"></span><br><span class="line">切换分支</span><br><span class="line">git checkout develop</span><br><span class="line"></span><br><span class="line">git branch feature_shanghongfan</span><br><span class="line"></span><br><span class="line">git checkout feature_shanghongfan</span><br><span class="line">----------------------------------------------------------------</span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line">git commit -m &quot;提交的信息&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">git push -u origin 分支名</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">git remote add origin 远程仓库地址</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="1-安装完git-配置git"><a href="#1-安装完git-配置git" class="headerlink" title="1.安装完git,配置git"></a>1.安装完git,配置git</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#配置用户名</span><br><span class="line">git config --global user.name &quot;xxx&quot;</span><br><span class="line">#配置邮箱</span><br><span class="line">git config --global user.email &quot;xxxx@126.com&quot;</span><br><span class="line"></span><br><span class="line">#查看配置信息</span><br><span class="line">cat ~&#x2F;.gitconfig</span><br><span class="line"></span><br><span class="line">git config --list</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="2-本地文件提交git管理"><a href="#2-本地文件提交git管理" class="headerlink" title="2.本地文件提交git管理"></a>2.本地文件提交git管理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#初始化本地仓库</span><br><span class="line">git init</span><br><span class="line">#将本地文件添加到暂存区</span><br><span class="line">git add a.txt</span><br><span class="line"></span><br><span class="line">#查看变化</span><br><span class="line">git status</span><br><span class="line"></span><br><span class="line">#提交暂存区文件到本地仓库</span><br><span class="line">git commit -m &quot;first commit&quot;</span><br><span class="line"></span><br><span class="line">#查看历史提交</span><br><span class="line">git log</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="3-git分支操作"><a href="#3-git分支操作" class="headerlink" title="3.git分支操作"></a>3.git分支操作</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">#git创建分支</span><br><span class="line">git branch hotfix</span><br><span class="line"></span><br><span class="line">#查看当前在哪个分支</span><br><span class="line">git branch -v</span><br><span class="line"></span><br><span class="line">#切换分支</span><br><span class="line">git checkout hotfix</span><br><span class="line"></span><br><span class="line">#修改bug,在新分支的a.txt文件中,添加一行fix bug</span><br><span class="line"></span><br><span class="line">#将文件添加到暂存区</span><br><span class="line">git add a.txt</span><br><span class="line"></span><br><span class="line">#将暂存区的文件提交到本地仓库</span><br><span class="line">git commit -m &quot;fix bug&quot;</span><br><span class="line"></span><br><span class="line">#查看日志</span><br><span class="line">git log</span><br><span class="line"></span><br><span class="line">#切换分支到master</span><br><span class="line">git checkout master</span><br><span class="line"></span><br><span class="line">#在master分支添加新功能代码(在a.txt文件添加一行 add feature)</span><br><span class="line"></span><br><span class="line">#将文件添加到暂存区</span><br><span class="line">git add a.txt</span><br><span class="line"></span><br><span class="line">#将暂存区的文件提交到本地仓库</span><br><span class="line">git commit -m &quot;add feature&quot;</span><br><span class="line"></span><br><span class="line">#查看提交日志</span><br><span class="line">git log</span><br><span class="line"></span><br><span class="line">#在master分支进行代码合并,并解决冲突</span><br><span class="line">#将hotfix分支合并到master</span><br><span class="line">git merge hotfix</span><br><span class="line"></span><br><span class="line">###手动解决冲突文件</span><br><span class="line"></span><br><span class="line">#在master分支,将文件添加到暂存区</span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line">#将暂存区的文件提交到本地仓库</span><br><span class="line">git commit -m &quot;fix conflicts&quot;</span><br><span class="line"></span><br><span class="line">#查看提交日志</span><br><span class="line">git log</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="4-Git远程仓库"><a href="#4-Git远程仓库" class="headerlink" title="4.Git远程仓库"></a>4.Git远程仓库</h3><p>分类</p>
<p>1.局域网环境下<br>    自己搭建Git服务器,如GitLab 服务器<br>2.外网环境下<br>    GitHub:<a target="_blank" rel="noopener" href="https://github.com/">https://github.com/</a></p>
<p>​     码云:<a target="_blank" rel="noopener" href="https://gitee.com/">https://gitee.com/</a></p>
<h4 id="4-1本地与远程仓库配置公钥和私钥"><a href="#4-1本地与远程仓库配置公钥和私钥" class="headerlink" title="4.1本地与远程仓库配置公钥和私钥"></a>4.1本地与远程仓库配置公钥和私钥</h4><p>1.在windows生成公钥和私钥</p>
<p>ssh-keygen -t rsa</p>
<p><img src="/img/1575270119266.png" alt="1575270119266"></p>
<p>2.将公钥配置给服务端</p>
<p>cat ~/.ssh/id_rsa.pub</p>
<p><img src="/img/1575270201471.png" alt="1575270201471"></p>
<p><img src="/img/1575270254476.png" alt="1575270254476"></p>
<p><img src="/img/1575270366581.png" alt="1575270366581"></p>
<p><img src="/img/1575270426472.png" alt="1575270426472"></p>
<h4 id="4-2将本地项目push到Github远程仓库"><a href="#4-2将本地项目push到Github远程仓库" class="headerlink" title="4.2将本地项目push到Github远程仓库"></a>4.2将本地项目push到Github远程仓库</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">关联github</span><br><span class="line">git remote add github git@github.com:xxx&#x2F;Code.git</span><br><span class="line"></span><br><span class="line">提交到gitHub,第一次提交</span><br><span class="line">git push -u github master</span><br><span class="line"></span><br><span class="line">如果要推送到GitHub，以后提交(hithub为用户名)</span><br><span class="line">git push github master(分支)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="4-3将Github远程仓库的代码clone到本地"><a href="#4-3将Github远程仓库的代码clone到本地" class="headerlink" title="4.3将Github远程仓库的代码clone到本地"></a>4.3将Github远程仓库的代码clone到本地</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#将Github远程仓库的代码clone到本地</span><br><span class="line">git clone git@github.com:xx&#x2F;Code.git</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#执行拉取操作同步远程代码到本地</span><br><span class="line">git pull</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="5-IDEA整合Git"><a href="#5-IDEA整合Git" class="headerlink" title="5.IDEA整合Git"></a>5.IDEA整合Git</h3><h4 id="5-1准备工作"><a href="#5-1准备工作" class="headerlink" title="5.1准备工作"></a>5.1准备工作</h4><h5 id="5-1-1设置文件状态变化-idea显示不同样式"><a href="#5-1-1设置文件状态变化-idea显示不同样式" class="headerlink" title="5.1.1设置文件状态变化,idea显示不同样式"></a>5.1.1设置文件状态变化,idea显示不同样式</h5><p><img src="/img/1575273617721.png" alt="1575273617721"></p>
<h5 id="5-1-2关联本地git安装目录中的git-exe"><a href="#5-1-2关联本地git安装目录中的git-exe" class="headerlink" title="5.1.2关联本地git安装目录中的git.exe"></a>5.1.2关联本地git安装目录中的git.exe</h5><p><img src="/img/1575273729664.png" alt="1575273729664"></p>
<p><img src="/img/1575273762559.png" alt="1575273762559"></p>
<h5 id="5-1-3关联Github"><a href="#5-1-3关联Github" class="headerlink" title="5.1.3关联Github"></a>5.1.3关联Github</h5><p><img src="/img/1575273838454.png" alt="1575273838454"></p>
<h5 id="5-1-4编写-gitignore文件放在项目根目录"><a href="#5-1-4编写-gitignore文件放在项目根目录" class="headerlink" title="5.1.4编写.gitignore文件放在项目根目录"></a>5.1.4编写.gitignore文件放在项目根目录</h5><p>里面编写的内容表示让git忽略这些文件不要提交到git仓库/不提交到远程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># Created by .ignore support plugin (hsz.mobi)</span><br><span class="line">### Java template</span><br><span class="line"># Compiled class file</span><br><span class="line">*.class</span><br><span class="line"></span><br><span class="line"># Log file</span><br><span class="line">*.log</span><br><span class="line"></span><br><span class="line"># BlueJ files</span><br><span class="line">*.ctxt</span><br><span class="line"></span><br><span class="line"># Mobile Tools for Java (J2ME)</span><br><span class="line">.mtj.tmp&#x2F;</span><br><span class="line"></span><br><span class="line"># Package Files #</span><br><span class="line">*.jar</span><br><span class="line">*.war</span><br><span class="line">*.nar</span><br><span class="line">*.ear</span><br><span class="line">*.zip</span><br><span class="line">*.tar.gz</span><br><span class="line">*.rar</span><br><span class="line"></span><br><span class="line"># virtual machine crash logs, see http:&#x2F;&#x2F;www.java.com&#x2F;en&#x2F;download&#x2F;help&#x2F;error_hotspot.xml</span><br><span class="line">hs_err_pid*</span><br><span class="line"></span><br><span class="line">### Scala template</span><br><span class="line">*.class</span><br><span class="line">*.log</span><br><span class="line"></span><br><span class="line"># Maven #</span><br><span class="line">target&#x2F;</span><br><span class="line"></span><br><span class="line"># IDEA #</span><br><span class="line">.idea&#x2F;</span><br><span class="line">*.iml</span><br><span class="line"></span><br><span class="line"># Eclipse #</span><br><span class="line">.settings&#x2F;</span><br><span class="line">.metadata&#x2F;</span><br><span class="line">.classpath</span><br><span class="line">.project</span><br><span class="line">Servers&#x2F;</span><br><span class="line"></span><br><span class="line"># Mac #</span><br><span class="line">.DS_Store</span><br></pre></td></tr></table></figure>

<h4 id="5-2分享项目"><a href="#5-2分享项目" class="headerlink" title="5.2分享项目"></a>5.2分享项目</h4><p><img src="/img/wps2.jpg" alt="wps2"></p>
<p><img src="/img/1575274658079.png" alt="1575274658079"></p>
<h4 id="5-3新增并提交代码"><a href="#5-3新增并提交代码" class="headerlink" title="5.3新增并提交代码"></a>5.3新增并提交代码</h4><p><img src="/img/1575274859684.png" alt="1575274859684"></p>
<p><img src="/img/1575274923917.png" alt="1575274923917"></p>
<h4 id="5-4push代码到远程仓库"><a href="#5-4push代码到远程仓库" class="headerlink" title="5.4push代码到远程仓库"></a>5.4push代码到远程仓库</h4><p>也可以单独commit再进行push</p>
<p><img src="/img/1575275035416.png" alt="1575275035416"></p>
<p>从Github检出代码</p>
<p><img src="/img/1575275214097.png" alt="1575275214097"></p>
<p><img src="/img/1575275297673.png" alt="1575275297673"></p>
<h4 id="5-5修改代码提交并push-出现冲突"><a href="#5-5修改代码提交并push-出现冲突" class="headerlink" title="5.5修改代码提交并push-出现冲突"></a>5.5修改代码提交并push-出现冲突</h4><p><img src="/img/1575276873980.png" alt="1575276873980"></p>
<h5 id="5-5-1解决冲突"><a href="#5-5-1解决冲突" class="headerlink" title="5.5.1解决冲突"></a>5.5.1解决冲突</h5><p><img src="/img/1575276976612.png" alt="1575276976612"></p>
<p><img src="/img/1575277051862.png" alt="1575277051862"></p>
<p><img src="/img/1575277108500.png" alt="1575277108500"></p>
<h5 id="5-5-2最后将解决完冲突的代码push到远程"><a href="#5-5-2最后将解决完冲突的代码push到远程" class="headerlink" title="5.5.2最后将解决完冲突的代码push到远程"></a>5.5.2最后将解决完冲突的代码push到远程</h5><p><img src="/img/1575277182331.png" alt="1575277182331"></p>
<h4 id="5-6分支操作"><a href="#5-6分支操作" class="headerlink" title="5.6分支操作"></a>5.6分支操作</h4><h5 id="5-6-1新建并切换到该分支"><a href="#5-6-1新建并切换到该分支" class="headerlink" title="5.6.1新建并切换到该分支"></a>5.6.1新建并切换到该分支</h5><p><img src="/img/1575277297024.png" alt="1575277297024"></p>
<p><img src="/img/1575277352645.png" alt="1575277352645"></p>
<p><img src="/img/1575277379955.png" alt="1575277379955"></p>
<h5 id="5-6-2修改代码提交代码并push到远程对应的分支"><a href="#5-6-2修改代码提交代码并push到远程对应的分支" class="headerlink" title="5.6.2修改代码提交代码并push到远程对应的分支"></a>5.6.2修改代码提交代码并push到远程对应的分支</h5><p><img src="/img/1575277571986.png" alt="1575277571986"></p>
<p><img src="/img/1575277694636.png" alt="1575277694636"></p>
<h5 id="5-6-3修改代码提交并push到master分支"><a href="#5-6-3修改代码提交并push到master分支" class="headerlink" title="5.6.3修改代码提交并push到master分支"></a>5.6.3修改代码提交并push到master分支</h5><p><img src="/img/1575278167086.png" alt="1575278167086"></p>
<h5 id="5-6-4将hotfix的代码合并到master最后push远程master"><a href="#5-6-4将hotfix的代码合并到master最后push远程master" class="headerlink" title="5.6.4将hotfix的代码合并到master最后push远程master"></a>5.6.4将hotfix的代码合并到master最后push远程master</h5><p>张三切换到master并将hotfix合并到master</p>
<p><img src="/img/1575278472210.png" alt="1575278472210"></p>
<h6 id="5-6-4-1解决冲突"><a href="#5-6-4-1解决冲突" class="headerlink" title="5.6.4.1解决冲突"></a>5.6.4.1解决冲突</h6><p><img src="/img/1575278557063.png" alt="1575278557063"></p>
<p><img src="/img/1575278599704.png" alt="1575278599704"></p>
<h3 id="6-将项目push到指定的私有仓库-切换指定仓库"><a href="#6-将项目push到指定的私有仓库-切换指定仓库" class="headerlink" title="6.将项目push到指定的私有仓库,切换指定仓库"></a>6.将项目push到指定的私有仓库,切换指定仓库</h3><p>将要push的项目和git断绝关系.删除.git文件</p>
<p>创建私有仓库</p>
<p><img src="/img/1575278868360.png" alt="1575278868360"></p>
<p><img src="/img/1575278887809.png" alt="1575278887809"></p>
<h4 id="6-1对项目开启git进行管理-在idea"><a href="#6-1对项目开启git进行管理-在idea" class="headerlink" title="6.1对项目开启git进行管理(在idea)"></a>6.1对项目开启git进行管理(在idea)</h4><p><img src="/img/1575278933550.png" alt="1575278933550"></p>
<h4 id="6-2先提交到本地再push到远程"><a href="#6-2先提交到本地再push到远程" class="headerlink" title="6.2先提交到本地再push到远程"></a>6.2先提交到本地再push到远程</h4><p><img src="/img/1575279181085.png" alt="1575279181085"></p>
<p><img src="/img/1575279201464.png" alt="1575279201464"></p>
<p><img src="/img/1575279235956.png" alt="1575279235956"></p>
<p><img src="/img/1575279283222.png" alt="1575279283222"></p>
<h3 id="7-github邀请别人加入"><a href="#7-github邀请别人加入" class="headerlink" title="7.github邀请别人加入"></a>7.github邀请别人加入</h3><p><img src="/img/1575279712999.png" alt="1575279712999"></p>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">git config 配置本地仓库，常用git config --global user.name、git config --global user.email</span><br><span class="line"></span><br><span class="line">git config --list 查看配置详情</span><br><span class="line"></span><br><span class="line">git init 初始一个仓库，添加--bare可以初始化一个共享（裸）仓库</span><br><span class="line"></span><br><span class="line">git status 可以查看当前仓库的状态</span><br><span class="line"></span><br><span class="line">git add“文件” 将工作区中的文件添加到暂存区中，其中file可是一个单独的文件，也可以是一个目录、“*”、-A</span><br><span class="line"></span><br><span class="line">git commit -m &#39;备注信息&#39; 将暂存区的文件，提交到本地仓库</span><br><span class="line"></span><br><span class="line">git log 可以查看本地仓库的提交历史</span><br><span class="line"></span><br><span class="line">git branch查看分支</span><br><span class="line"></span><br><span class="line">git branch“分支名称” 创建一个新的分支</span><br><span class="line"></span><br><span class="line">git checkout“分支名称” 切换分支</span><br><span class="line"></span><br><span class="line">git checkout -b deeveloper 创建并切到developer分支</span><br><span class="line"></span><br><span class="line">git merge“分支名称” 合并分支</span><br><span class="line"></span><br><span class="line">git branch -d “分支名称” 删除分支</span><br><span class="line"></span><br><span class="line">git remote -v 查看当前所有远程地址别名</span><br><span class="line"></span><br><span class="line">git remote add 别名 远程仓库地址	添加远程主机，即给远程主机起个别名，方便使用</span><br><span class="line"></span><br><span class="line">git remote add origin [git@github.com:bigdata-caowei&#x2F;userprofile_29.git](mailto:git@github.com:bigdata-caowei&#x2F;userprofile_29.git)</span><br><span class="line"></span><br><span class="line">git remote 可以查看已添加的远程主机</span><br><span class="line"></span><br><span class="line">git remote show “主机名称”可以查看远程主机的信息</span><br><span class="line"></span><br><span class="line">git remote rm 主机名 删除主机名</span><br><span class="line"></span><br><span class="line">git clone “仓库地址”获取已有仓库的副本</span><br><span class="line"></span><br><span class="line">git clone git@github.com:bigdata-caowei&#x2F;userprofile_29.git</span><br><span class="line"></span><br><span class="line">git push origin “本地分支名称:远程分支名称”将本地分支推送至远程仓库，</span><br><span class="line"></span><br><span class="line">git push origin hotfix（通常的写法,本地仓库分支名称和远程仓库分支名称一样的情况下可以简写成一个）相当于git push origin hotfix:hotfix</span><br><span class="line"></span><br><span class="line">git push origin hotfix:newfeature 如果远程仓库没有对应分支，将会自动创建</span><br><span class="line"></span><br><span class="line">git pull 拉取</span><br><span class="line"></span><br><span class="line">pull&#x3D;fetch+merge</span><br><span class="line"></span><br><span class="line">git fetch [远程库地址别名] [远程分支名]</span><br><span class="line"></span><br><span class="line">git merge [远程库地址别名&#x2F;远程分支名]</span><br><span class="line"></span><br><span class="line">git pull [远程库地址别名] [远程分支名]</span><br></pre></td></tr></table></figure>



<h2 id="常用操作流程图解"><a href="#常用操作流程图解" class="headerlink" title="常用操作流程图解"></a>常用操作流程图解</h2><p><img src="/img/1575280093454.png" alt="1575280093454"></p>
<h2 id="常用命令速查表"><a href="#常用命令速查表" class="headerlink" title="常用命令速查表"></a>常用命令速查表</h2><p><img src="/img/1575280116805.png" alt="1575280116805"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/19/git%E4%BD%BF%E7%94%A8/" data-id="ckw5znxwb0009w9ghcbvxhrp2" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-Flink基础-Window-Watermark" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2020/01/02/Flink%E5%9F%BA%E7%A1%80-Window-Watermark/">Flink基础-Window&amp;Watermark</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/02/Flink%E5%9F%BA%E7%A1%80-Window-Watermark/" class="article-date">
  <time datetime="2020-01-01T17:00:00.000Z" itemprop="datePublished">2020-01-02</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
      <h4 id="1-1-Flink-Window操作"><a href="#1-1-Flink-Window操作" class="headerlink" title="1.1.Flink Window操作"></a>1.1.Flink Window操作</h4><p>Flink任务Batch是Streaming的一个特例，因此Flink底层引擎是一个流式引擎，在上面实现了流处理和批处理。而Window就是从Streaming到Batch的桥梁</p>
<p>Window窗口就在一个无界流中设置起始位置和终止位置，让无界流变成有界流，并且在有界流中进行数据处理</p>
<p>Window操作常见的业务场景：统计过去一段时间、最近一些元素的数据指标</p>
<h4 id="1-2-Window窗口分类"><a href="#1-2-Window窗口分类" class="headerlink" title="1.2.Window窗口分类"></a>1.2.Window窗口分类</h4><p>Window窗口在无界流中设置起始位置和终止位置的方式可以有两种：</p>
<ul>
<li>根据时间设置</li>
<li>根据窗口数据量（count）设置</li>
</ul>
<p>根据窗口的类型划分：</p>
<ul>
<li>滚动窗口</li>
<li>滑动窗口</li>
</ul>
<p>根据数据流类型划分：</p>
<ul>
<li>Keyed Window：基于分组后的数据流之上做窗口操作</li>
<li>Global Window：基于未分组的数据流之上做窗口操作</li>
</ul>
<p>根据不同的组合方式，可以组合出来8种窗口类型：</p>
<ol>
<li><p>基于分组后的数据流上的时间滚动窗口</p>
</li>
<li><p>基于分组后的数据流上的时间滑动窗口</p>
</li>
<li><p>基于分组后的数据流上的count滚动窗口</p>
</li>
<li><p>基于分组后的数据流上的count滑动窗口</p>
</li>
<li><p>基于未分组的数据流上的时间滚动窗口</p>
</li>
<li><p>基于未分组的数据流上的时间滑动窗口</p>
</li>
<li><p>基于未分组的数据流上的count滚动窗口</p>
</li>
<li><p>基于未分组的数据流上的count滑动窗口</p>
</li>
</ol>
<p>当然我们也可以根据实际业务场景自定义Window，这就是Flink最大的优势：Window种类多，灵活</p>
<p>Time Window（基于时间的窗口）</p>
<p>Tumbling Window：滚动窗口，窗口之间没有数据重叠</p>
<p><img src="/img/image-20211025110303877.png" alt="image-20211025110303877"></p>
<p>Sliding Window：滑动窗口，窗口内的数据有重叠</p>
<p>在定义滑动窗口的时候，不只是要定义窗口大小，还要定义窗口的滑动间隔时间（每隔多久</p>
<p>滑动一次），如果滑动间隔时间=窗口大小=滚动窗口</p>
<p><img src="/img%5Cimage-20211025110356614.png" alt="image-20211025110356614"></p>
<p>另外还有会话窗口Session Window，此种一般不用</p>
<p><img src="/img%5Cimage-20211025172052343.png" alt="image-20211025172052343"></p>
<h4 id="1-3-窗口聚合函数"><a href="#1-3-窗口聚合函数" class="headerlink" title="1.3.窗口聚合函数"></a>1.3.窗口聚合函数</h4><p>窗口函数定义了针对窗口内元素的计算逻辑，窗口函数大概分为两类：</p>
<ol>
<li>增量聚合函数，聚合原理：窗口内保存一个中间聚合结果，随着新元素的加入，不断对该值进行更新</li>
</ol>
<p>​    这类函数通常非常节省空间 ReduceFunction、AggregateFunction属于增量聚合函数</p>
<ol start="2">
<li>全量聚合函数，聚合原理：收集窗口内的所有元素，并且在执行的时候对他们进行遍历，这种聚合函数通常需要占用更多的空间（收集一段时间的数据并且保存），但是它可以支持更复杂的逻辑ProcessWindowFunction、WindowFunction属于全量窗口函数</li>
</ol>
<p>注意：这两类函数可以组合搭配使用</p>
<h5 id="1-3-1-增量聚合函数"><a href="#1-3-1-增量聚合函数" class="headerlink" title="1.3.1.增量聚合函数"></a>1.3.1.增量聚合函数</h5><h6 id="案例一-使用增量聚合函数统计最近5s内，各个卡口的车流量"><a href="#案例一-使用增量聚合函数统计最近5s内，各个卡口的车流量" class="headerlink" title="案例一:使用增量聚合函数统计最近5s内，各个卡口的车流量"></a>案例一:使用增量聚合函数统计最近5s内，各个卡口的车流量</h6><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.<span class="type">StringUtils</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.<span class="type">SimpleStringSchema</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.&#123;<span class="type">ProcessWindowFunction</span>, <span class="type">WindowFunction</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingProcessingTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用增量聚合函数统计最近5s内，各个卡口的车流量</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">StatisCarFlow</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="keyword">val</span> props = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    props.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;hadoop001:9092&quot;</span>)</span><br><span class="line">    props.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;StatisCarFlow&quot;</span>)</span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="type">FlinkKafkaConsumer</span>[<span class="type">String</span>](<span class="string">&quot;traffic_info&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), props).setStartFromEarliest())</span><br><span class="line">      .filter(line =&gt; <span class="type">StringUtils</span>.isNotEmpty(line) &amp;&amp; !line.equals(<span class="string">&quot;None&quot;</span>))</span><br><span class="line">      .map(line =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">1</span>), <span class="number">1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      ).keyBy(_._1).window(<span class="type">TumblingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">5</span>)))</span><br><span class="line">      .aggregate(<span class="keyword">new</span> <span class="type">AggregateFunction</span>[(<span class="type">String</span>, <span class="type">Int</span>), <span class="type">Int</span>, <span class="type">Int</span>]() &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): <span class="type">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(value: (<span class="type">String</span>, <span class="type">Int</span>), accumulator: <span class="type">Int</span>): <span class="type">Int</span> = accumulator + value._2</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(accumulator: <span class="type">Int</span>): <span class="type">Int</span> = accumulator</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(a: <span class="type">Int</span>, b: <span class="type">Int</span>): <span class="type">Int</span> = a + b</span><br><span class="line">      &#125;,</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * ProcessWindowFunction、WindowFunction区别在于ProcessWindowFunction可以获取Flink执行的</span></span><br><span class="line"><span class="comment">         * 上下文，可以拿到当前的数据更多信息，比如窗口状态、窗口起始与终止时间、当前水印、时间戳等</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//        new WindowFunction[Int, (String, Int), String, TimeWindow] &#123;</span></span><br><span class="line">        <span class="comment">//          override def apply(key: String, window: TimeWindow, input: Iterable[Int], out: Collector[(String, Int)]): Unit = &#123;</span></span><br><span class="line">        <span class="comment">//            for (elem &lt;- input) &#123;</span></span><br><span class="line">        <span class="comment">//               out.collect((key, elem))</span></span><br><span class="line">        <span class="comment">//            &#125;</span></span><br><span class="line">        <span class="comment">//          &#125;</span></span><br><span class="line">        <span class="comment">//        &#125;</span></span><br><span class="line">        <span class="keyword">new</span> <span class="type">ProcessWindowFunction</span>[<span class="type">Int</span>, (<span class="type">String</span>, <span class="type">Int</span>), <span class="type">String</span>, <span class="type">TimeWindow</span>] &#123;</span><br><span class="line">          <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(key: <span class="type">String</span>, context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[<span class="type">Int</span>], out: <span class="type">Collector</span>[(<span class="type">String</span>, <span class="type">Int</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">            <span class="keyword">for</span> (elem &lt;- elements) &#123;</span><br><span class="line">              out.collect((key, elem))</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ).print()</span><br><span class="line">    env.execute(<span class="type">StatisCarFlow</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="案例二-每隔10s统计每辆汽车的平均速度"><a href="#案例二-每隔10s统计每辆汽车的平均速度" class="headerlink" title="案例二:每隔10s统计每辆汽车的平均速度"></a>案例二:每隔10s统计每辆汽车的平均速度</h6><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.<span class="type">StringUtils</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">AggregateFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.<span class="type">SimpleStringSchema</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingProcessingTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每隔10s统计每辆汽车的平均速度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Demo02SpeedAVG</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="keyword">val</span> props = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    props.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;hadoop001:9092&quot;</span>)</span><br><span class="line">    props.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;StatisCarFlow&quot;</span>)</span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="type">FlinkKafkaConsumer</span>[<span class="type">String</span>](<span class="string">&quot;traffic_info&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), props).setStartFromEarliest())</span><br><span class="line">      .filter(line =&gt; <span class="type">StringUtils</span>.isNotEmpty(line) &amp;&amp; !line.equals(<span class="string">&quot;None&quot;</span>))</span><br><span class="line">      .map(line =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">3</span>), strings(<span class="number">4</span>).toDouble)</span><br><span class="line">      &#125;</span><br><span class="line">      ).keyBy(_._1).window(<span class="type">TumblingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .aggregate(<span class="keyword">new</span> <span class="type">AggregateFunction</span>[(<span class="type">String</span>, <span class="type">Double</span>), (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>), (<span class="type">String</span>, <span class="type">Double</span>)] &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createAccumulator</span></span>(): (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>) = (<span class="string">&quot;&quot;</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(value: (<span class="type">String</span>, <span class="type">Double</span>), accumulator: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>)): (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>) = (value._1, accumulator._2 + value._2, accumulator._3 + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getResult</span></span>(accumulator: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>)): (<span class="type">String</span>, <span class="type">Double</span>) = (accumulator._1, accumulator._2 / accumulator._3)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">merge</span></span>(a: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>), b: (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>)): (<span class="type">String</span>, <span class="type">Double</span>, <span class="type">Int</span>) = (a._1, a._2 + b._2, a._3 + b._3)</span><br><span class="line">      &#125;).print()</span><br><span class="line">    env.execute(<span class="type">Demo02SpeedAVG</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="1-3-2-全量聚合函数"><a href="#1-3-2-全量聚合函数" class="headerlink" title="1.3.2.全量聚合函数"></a>1.3.2.全量聚合函数</h5><h6 id="案例三-每隔10s对窗口内所有汽车的车速进行排序"><a href="#案例三-每隔10s对窗口内所有汽车的车速进行排序" class="headerlink" title="案例三:每隔10s对窗口内所有汽车的车速进行排序"></a>案例三:每隔10s对窗口内所有汽车的车速进行排序</h6><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.<span class="type">StringUtils</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.<span class="type">SimpleStringSchema</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessAllWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingProcessingTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每隔10s对窗口内所有汽车的车速进行排序</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Demo03SortSpeed</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> props = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    props.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;hadoop001:9092&quot;</span>)</span><br><span class="line">    props.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;StatisCarFlow&quot;</span>)</span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="type">FlinkKafkaConsumer</span>[<span class="type">String</span>](<span class="string">&quot;traffic_info&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), props).setStartFromEarliest())</span><br><span class="line">      .filter(line =&gt; <span class="type">StringUtils</span>.isNotEmpty(line) &amp;&amp; !line.equals(<span class="string">&quot;None&quot;</span>))</span><br><span class="line">      .map(line =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">1</span>), strings(<span class="number">4</span>).toDouble)</span><br><span class="line">      &#125;).windowAll(<span class="type">TumblingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      <span class="comment">// 注意：想要全局排序并行度需要设置为1</span></span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">ProcessAllWindowFunction</span>[(<span class="type">String</span>, <span class="type">Double</span>), (<span class="type">String</span>, <span class="type">Double</span>), <span class="type">TimeWindow</span>] &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[(<span class="type">String</span>, <span class="type">Double</span>)], out: <span class="type">Collector</span>[(<span class="type">String</span>, <span class="type">Double</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">          <span class="keyword">val</span> list = elements.toList.sortBy(_._2)</span><br><span class="line">          <span class="keyword">for</span> (ele &lt;- list) &#123;</span><br><span class="line">            out.collect(ele._1, ele._2)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).print()</span><br><span class="line">    env.execute(<span class="type">Demo03SortSpeed</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h6 id="案例四-每隔10s统计出窗口内所有车辆的最大及最小速度"><a href="#案例四-每隔10s统计出窗口内所有车辆的最大及最小速度" class="headerlink" title="案例四:每隔10s统计出窗口内所有车辆的最大及最小速度"></a>案例四:每隔10s统计出窗口内所有车辆的最大及最小速度</h6><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.<span class="type">StringUtils</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.<span class="type">SimpleStringSchema</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessAllWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingProcessingTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每隔10s统计出窗口内所有车辆的最大及最小速度</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Demo04MaxMinSpeed</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> props = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    props.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;hadoop001:9092&quot;</span>)</span><br><span class="line">    props.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;StatisCarFlow&quot;</span>)</span><br><span class="line">    env.addSource(<span class="keyword">new</span> <span class="type">FlinkKafkaConsumer</span>[<span class="type">String</span>](<span class="string">&quot;traffic_info&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), props).setStartFromEarliest())</span><br><span class="line">      .filter(line =&gt; <span class="type">StringUtils</span>.isNotEmpty(line) &amp;&amp; !line.equals(<span class="string">&quot;None&quot;</span>))</span><br><span class="line">      .map(line =&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> strings = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        (strings(<span class="number">1</span>), strings(<span class="number">4</span>).toDouble)</span><br><span class="line">      &#125;</span><br><span class="line">      ).windowAll(<span class="type">TumblingProcessingTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .process(<span class="keyword">new</span> <span class="type">ProcessAllWindowFunction</span>[(<span class="type">String</span>, <span class="type">Double</span>), <span class="type">String</span>, <span class="type">TimeWindow</span>] &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[(<span class="type">String</span>, <span class="type">Double</span>)], out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">          <span class="keyword">val</span> list = elements.toList.sortBy(_._2)</span><br><span class="line">          <span class="keyword">val</span> minSpeed = list.head</span><br><span class="line">          <span class="keyword">val</span> maxSpeed = list.last</span><br><span class="line">          <span class="keyword">val</span> startWindowTime = context.window.getStart</span><br><span class="line">          <span class="keyword">val</span> endWindowTime = context.window.getEnd</span><br><span class="line">          out.collect(<span class="string">s&quot;minSpeed:<span class="subst">$minSpeed</span>,maxSpeed:<span class="subst">$maxSpeed</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).print()</span><br><span class="line"></span><br><span class="line">    env.execute(<span class="type">Demo04MaxMinSpeed</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-4-Flink-Time时间语义"><a href="#1-4-Flink-Time时间语义" class="headerlink" title="1.4.Flink Time时间语义"></a>1.4.Flink Time时间语义</h4><p>Flink定义了三类时间</p>
<ul>
<li>处理时间（Process Time）数据进入Flink被处理的系统时间（Operator处理数据的系统时间）</li>
<li>事件时间（Event Time）数据在数据源产生的时间，一般由事件中的时间戳描述，比如用户日志中的TimeStamp</li>
<li>摄取时间（Ingestion Time）数据进入Flink的时间，记录被Source节点观察到的系统时间</li>
</ul>
<p><img src="/img%5Cimage-20211025150546185.png" alt="image-20211025150546185"></p>
<p>Flink流式计算的时候需要显示定义时间语义，根据不同的时间语义来处理数据，比如指定的时间语义是</p>
<p>事件时间，那么我们就要切换到事件时间的世界观中，窗口的起始与终止时间都是以事件时间为依据</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置时间语义为Ingestion Time </span></span><br><span class="line">env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">IngestionTime</span>)</span><br><span class="line"><span class="comment">// 设置时间语义为Event Time 我们还需要指定一下数据中哪个字段是事件时间</span></span><br><span class="line">env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br></pre></td></tr></table></figure>

<h5 id="1-4-1-基于事件时间的Window操作"><a href="#1-4-1-基于事件时间的Window操作" class="headerlink" title="1.4.1.基于事件时间的Window操作"></a>1.4.1.基于事件时间的Window操作</h5><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window.eventtime</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingEventTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于事件时间的Window操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">EventTimeWindow</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="comment">// flink1.12版本后默认的为EventTime</span></span><br><span class="line">    <span class="comment">//    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</span></span><br><span class="line">    <span class="keyword">val</span> source = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    source.assignAscendingTimestamps(data =&gt; &#123;</span><br><span class="line">      data.split(<span class="string">&quot;,&quot;</span>)(<span class="number">0</span>).toLong</span><br><span class="line">    &#125;)</span><br><span class="line">      .flatMap(x =&gt; x.split(<span class="string">&quot;,&quot;</span>).tail).map((_, <span class="number">1</span>)).keyBy(_._1)</span><br><span class="line">      .window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .reduce((v1: (<span class="type">String</span>, <span class="type">Int</span>), v2: (<span class="type">String</span>, <span class="type">Int</span>)) =&gt; &#123;</span><br><span class="line">        (v1._1, v1._2 + v2._2)</span><br><span class="line">      &#125;)</span><br><span class="line">      .print()</span><br><span class="line">    env.execute(<span class="type">EventTimeWindow</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="1-5-Watermark"><a href="#1-5-Watermark" class="headerlink" title="1.5. Watermark"></a>1.5. Watermark</h4><h5 id="1-5-1-Watermark介绍"><a href="#1-5-1-Watermark介绍" class="headerlink" title="1.5.1. Watermark介绍"></a>1.5.1. Watermark介绍</h5><p>官网地址:</p>
<p><a target="_blank" rel="noopener" href="https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/event_timestamps_watermarks.html#writing-a-periodic-watermarkgenerator">https://ci.apache.org/projects/flink/flink-docs-release-1.12/dev/event_timestamps_watermarks.html#writing-a-periodic-watermarkgenerator</a></p>
<p>Watermark本质就是时间戳,在使用Flink处理数据的时候，数据通常都是按照事件产生的时间（事件时间）的顺序进入到Flink，但是在遇到特殊情况下，比如遇到网络延迟或者使用Kafka（多分区） 很难保证数据都是按照事件时间的顺序进入Flink，很有可能是乱序进入。</p>
<p>如果使用的是事件时间这个语义，数据一旦是乱序进入，那么在使用Window处理数据的时候，就会出现延迟数据不会被计算的问题</p>
<p><img src="/img%5Cimage-20211027092324003.png" alt="image-20211027092324003"></p>
<p><img src="/img%5Cimage-20211027092703537.png" alt="image-20211027092703537"></p>
<p>举例： Window窗口长度10s，滚动窗口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">001 zs 2020-04-25 10:00:01</span><br><span class="line">001 zs 2020-04-25 10:00:02</span><br><span class="line">001 zs 2020-04-25 10:00:03</span><br><span class="line">001 zs 2020-04-25 10:00:11 窗口触发执行</span><br><span class="line">001 zs 2020-04-25 10:00:05 延迟数据，不会被上一个窗口所计算导致计算结果不正确</span><br></pre></td></tr></table></figure>

<p>Watermark+Window可以很好的解决延迟数据的问题</p>
<p>Flink窗口计算的过程中，如果数据全部到达就会到窗口中的数据做处理，如果有延迟数据，那么窗口需要等待全部的数据到来之后，再触发窗口执行，需要等待多久？不可能无限期等待，我们用户可以自己来设置延迟时间这样就可以<strong>尽可能</strong>保证延迟数据被处理</p>
<p>根据用户指定的延迟时间生成水印（Watermak = 最大事件时间-指定延迟时间）</p>
<p>当Watermak 大于等于窗口的停止时间，这个窗口就会被触发执行</p>
<p>举例：Window窗口长度10s(01-10)，滚动窗口，指定延迟时间3s</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">01</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">09</span>:<span class="number">59</span>:<span class="number">58</span></span><br><span class="line">env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>) </span><br><span class="line"><span class="keyword">val</span> stream = env.socketTextStream(<span class="string">&quot;node01&quot;</span>, <span class="number">8888</span>).assignAscendingTimestamps(data =&gt; &#123; </span><br><span class="line"><span class="keyword">val</span> splits = data.split(<span class="string">&quot; &quot;</span>) </span><br><span class="line">splits(<span class="number">0</span>).toLong </span><br><span class="line">&#125;)</span><br><span class="line">stream .flatMap(x=&gt;x.split(<span class="string">&quot; &quot;</span>).tail) .map((_, <span class="number">1</span>)) .keyBy(_._1) </span><br><span class="line"><span class="comment">// .timeWindow(Time.seconds(10)) </span></span><br><span class="line">.window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>))) </span><br><span class="line">.reduce((v1: (<span class="type">String</span>, <span class="type">Int</span>), v2: (<span class="type">String</span>, <span class="type">Int</span>)) =&gt; &#123; </span><br><span class="line">(v1._1, v1._2 + v2._2) </span><br><span class="line">&#125;).print() </span><br><span class="line">env.execute() </span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">09</span>:<span class="number">59</span>:<span class="number">59</span></span><br><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">03</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">09</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">06</span></span><br><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">12</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">09</span></span><br><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">08</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">05</span> 延迟数据</span><br><span class="line"><span class="number">001</span> ls <span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">13</span> wm:<span class="number">2020</span><span class="number">-04</span><span class="number">-25</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">10</span> 此时wm &gt;= window end time 触发窗口</span><br><span class="line">执行 处理的是事件时间<span class="number">01</span><span class="number">-10</span>的数据，并不是水印时间为<span class="number">01</span><span class="number">-10</span>的数据 **重点**</span><br><span class="line">讲道理，如果没有<span class="type">Watermark</span>在倒数第三条数据来的时候，就会触发执行，那么倒数第二条的延迟数据</span><br><span class="line">就不会被计算，那么有了水印可以处理延迟<span class="number">3</span>s内的数据</span><br></pre></td></tr></table></figure>

<p>注意：如果数据不会乱序进入Flink，没必要使用Watermark</p>
<p>代码演示</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window.watermark</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xyz.window.eventtime.<span class="type">EventTimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.<span class="type">BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingEventTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WatermarkDemo1</span></span><br><span class="line"><span class="comment"> * 测试数据</span></span><br><span class="line"><span class="comment">10000,hello,msb</span></span><br><span class="line"><span class="comment">14000,hello,flink</span></span><br><span class="line"><span class="comment">20000,hello,hadoop</span></span><br><span class="line"><span class="comment">21000,hello,bj</span></span><br><span class="line"><span class="comment">17000,hello,sh</span></span><br><span class="line"><span class="comment">23000,hello,jjj</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">WatermarkDemo1</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="comment">// flink1.12版本后默认的为EventTime</span></span><br><span class="line">    <span class="comment">//    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</span></span><br><span class="line">    <span class="keyword">val</span> source = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    source.assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[<span class="type">String</span>](<span class="type">Time</span>.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: <span class="type">String</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">        element.split(<span class="string">&quot;,&quot;</span>)(<span class="number">0</span>).toLong</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">      .flatMap(x =&gt; x.split(<span class="string">&quot;,&quot;</span>).tail).map((_, <span class="number">1</span>)).keyBy(_._1)</span><br><span class="line">      .window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .reduce((v1: (<span class="type">String</span>, <span class="type">Int</span>), v2: (<span class="type">String</span>, <span class="type">Int</span>)) =&gt; &#123;</span><br><span class="line">        (v1._1, v1._2 + v2._2)</span><br><span class="line">      &#125;)</span><br><span class="line">      .print()</span><br><span class="line">    env.execute(<span class="type">WatermarkDemo1</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="1-5-2-Watermark生产策略"><a href="#1-5-2-Watermark生产策略" class="headerlink" title="1.5.2. Watermark生产策略"></a>1.5.2. Watermark生产策略</h5><h6 id="周期性水印（Periodic-Watermark）"><a href="#周期性水印（Periodic-Watermark）" class="headerlink" title="周期性水印（Periodic Watermark）"></a>周期性水印（Periodic Watermark）</h6><p>根据事件或者处理时间周期性的触发水印生成器(Assigner)，默认100ms，每隔100毫秒自动向流里注入一个Watermark</p>
<p>代码案例一:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window.watermark</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.<span class="type">BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingEventTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 周期性水印（Periodic Watermark）根据事件或者处理时间周期性的触发水印生成器(Assigner)</span></span><br><span class="line"><span class="comment"> * 默认100ms，每隔100毫秒自动向流里注入一个Watermark周期性水印API</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">PeriodicWatermarkDemo1</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="comment">// flink1.12版本后默认的为EventTime</span></span><br><span class="line">    <span class="comment">//    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</span></span><br><span class="line">    env.getConfig.setAutoWatermarkInterval(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">val</span> source = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    source.assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[<span class="type">String</span>](<span class="type">Time</span>.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: <span class="type">String</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">        element.split(<span class="string">&quot;,&quot;</span>)(<span class="number">0</span>).toLong</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">      .flatMap(x =&gt; x.split(<span class="string">&quot;,&quot;</span>).tail).map((_, <span class="number">1</span>)).keyBy(_._1)</span><br><span class="line">      .window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .reduce((v1: (<span class="type">String</span>, <span class="type">Int</span>), v2: (<span class="type">String</span>, <span class="type">Int</span>)) =&gt; &#123;</span><br><span class="line">        (v1._1, v1._2 + v2._2)</span><br><span class="line">      &#125;)</span><br><span class="line">      .print()</span><br><span class="line">    env.execute(<span class="type">PeriodicWatermarkDemo1</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代码案例二:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window.watermark</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.<span class="type">AssignerWithPeriodicWatermarks</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.watermark.<span class="type">Watermark</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingEventTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 周期性水印自定义生成</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">PeriodicWatermarkDemo2</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="comment">// flink1.12版本后默认的为EventTime</span></span><br><span class="line">    <span class="comment">//    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</span></span><br><span class="line">    env.getConfig.setAutoWatermarkInterval(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">val</span> source = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    source.assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">MyTimestampAndWatermarks</span>(<span class="number">3000</span>))</span><br><span class="line">      .flatMap(x =&gt; x.split(<span class="string">&quot;,&quot;</span>).tail).map((_, <span class="number">1</span>)).keyBy(_._1)</span><br><span class="line">      .window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .reduce((v1: (<span class="type">String</span>, <span class="type">Int</span>), v2: (<span class="type">String</span>, <span class="type">Int</span>)) =&gt; &#123;</span><br><span class="line">        (v1._1, v1._2 + v2._2)</span><br><span class="line">      &#125;)</span><br><span class="line">      .print()</span><br><span class="line">    env.execute(<span class="type">PeriodicWatermarkDemo2</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">MyTimestampAndWatermarks</span>(<span class="params">delayTime: <span class="type">Long</span></span>) <span class="keyword">extends</span> <span class="title">AssignerWithPeriodicWatermarks</span>[<span class="type">String</span>] </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> maxCurrentWatermark: <span class="type">Long</span> = _</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 水印=最大事件时间-延迟时间 后被调用 水印是递增，小于上一个水印不会被发射出去</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">getCurrentWatermark</span></span>: <span class="type">Watermark</span> = &#123;</span><br><span class="line">      <span class="comment">// 产生水印</span></span><br><span class="line">      <span class="keyword">new</span> <span class="type">Watermark</span>(maxCurrentWatermark - delayTime)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取当前的时间戳 先被调用</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: <span class="type">String</span>, recordTimestamp: <span class="type">Long</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> currentTimeStamp = element.split(<span class="string">&quot;,&quot;</span>)(<span class="number">0</span>).toLong</span><br><span class="line">      maxCurrentWatermark = math.max(currentTimeStamp, maxCurrentWatermark)</span><br><span class="line">      currentTimeStamp</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="间歇性水印（Punctuated-Watermark）"><a href="#间歇性水印（Punctuated-Watermark）" class="headerlink" title="间歇性水印（Punctuated Watermark）"></a>间歇性水印（Punctuated Watermark）</h6><p>在观察到事件后，会依据用户指定的条件来决定是否发射水印</p>
<p>比如，在车流量的数据中，001卡口通信经常异常，传回到服务器的数据会有延迟问题，其他的卡口都是正常的，那么这个卡口的数据需要打上水印</p>
<p>代码案例三:</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window.watermark</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">ReduceFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.<span class="type">AssignerWithPunctuatedWatermarks</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.watermark.<span class="type">Watermark</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.assigners.<span class="type">TumblingEventTimeWindows</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">001,10000</span></span><br><span class="line"><span class="comment">002,14000</span></span><br><span class="line"><span class="comment">002,20000</span></span><br><span class="line"><span class="comment">002,21000</span></span><br><span class="line"><span class="comment">001,17000</span></span><br><span class="line"><span class="comment">002,23000</span></span><br><span class="line"><span class="comment">001,23000</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">PunctuatedWatermarkDemo1</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// flink1.12版本后默认的为EventTime</span></span><br><span class="line">    <span class="comment">//    env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</span></span><br><span class="line">    env.getConfig.setAutoWatermarkInterval(<span class="number">100</span>)</span><br><span class="line">    <span class="keyword">val</span> source = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    source.map(line =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> arr = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">      (arr(<span class="number">0</span>), arr(<span class="number">1</span>).toLong)</span><br><span class="line">    &#125;)</span><br><span class="line">      .assignTimestampsAndWatermarks(<span class="keyword">new</span> myWatermark(<span class="number">3000</span>))</span><br><span class="line">      .map(value =&gt; &#123;</span><br><span class="line">        (value._1, <span class="number">1</span>)</span><br><span class="line">      &#125;)</span><br><span class="line">      .keyBy(_._1).window(<span class="type">TumblingEventTimeWindows</span>.of(<span class="type">Time</span>.seconds(<span class="number">10</span>)))</span><br><span class="line">      .reduce(<span class="keyword">new</span> <span class="type">ReduceFunction</span>[(<span class="type">String</span>, <span class="type">Int</span>)] &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">reduce</span></span>(value1: (<span class="type">String</span>, <span class="type">Int</span>), value2: (<span class="type">String</span>, <span class="type">Int</span>)): (<span class="type">String</span>, <span class="type">Int</span>) = (value1._1, value1._2 + value2._2)</span><br><span class="line">      &#125;)</span><br><span class="line"></span><br><span class="line">      .print()</span><br><span class="line">    env.execute(<span class="type">PunctuatedWatermarkDemo1</span>.getClass.getName)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">myWatermark</span>(<span class="params">delay: <span class="type">Long</span></span>) <span class="keyword">extends</span> <span class="title">AssignerWithPunctuatedWatermarks</span>[(<span class="type">String</span>, <span class="type">Long</span>)] </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> maxTimeStamp: <span class="type">Long</span> = _</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">checkAndGetNextWatermark</span></span>(elem: (<span class="type">String</span>, <span class="type">Long</span>), extractedTimestamp: <span class="type">Long</span>): <span class="type">Watermark</span> = &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="string">&quot;001&quot;</span>.equals(elem._1)) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="type">Watermark</span>(maxTimeStamp - delay)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: (<span class="type">String</span>, <span class="type">Long</span>), previousElementTimestamp: <span class="type">Long</span>): <span class="type">Long</span> = &#123;</span><br><span class="line">      maxTimeStamp = math.max(element._2, maxTimeStamp)</span><br><span class="line">      element._2</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-6-AllowedLateness"><a href="#1-6-AllowedLateness" class="headerlink" title="1.6.AllowedLateness"></a>1.6.AllowedLateness</h4><p>基于Event-Time的窗口处理流式数据，虽然提供了Watermark机制，却只能在一定程度上解决了数据乱序的问题。但在某些情况下数据可能延时会非常严重，即使通过Watermark机制也无法等到数据全部进入窗口再进行处理。Flink中默认会将这些迟到的数据做丢弃处理，但是有些时候用户希望即使数据延迟并不是很严重的情况下，也能继续窗口计算，不希望对于数据延迟比较严重的数据混入正常的计算流程中，此时就需要使用Allowed Lateness机制来对迟到的数据进行额外的处理。</p>
<p>举例：例如用户大屏数据展示系统，即使正常的窗口中没有将迟到的数据进行统计，但为了保证页面数据显示的连续性，后来接入到系统中迟到比较严重的数据所统计出来的结果不希望显示在屏幕上，而是将延时数据和结果存储到数据库中，便于后期对延时数据进行分析。对于这种情况需要借助Side Output来处理，通过使用sideOutputLateData（OutputTag）来标记迟到数据计算的结果，然后使用getSideOutput（lateOutputTag）从窗口结果中获取lateOutputTag标签对应的数据，之后转成独立的DataStream数据集进行处理，创建late-data的OutputTag，再通过该标签从窗口结果中将迟到数据筛选出来</p>
<p>Flink默认当窗口计算完毕后，窗口元素数据及状态会被清空，但是使用AllowedLateness，可以延迟清除窗口元素数据及状态，以便于当延迟数据到来的时候，能够重新计算当前窗口</p>
<p>代码案例</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.window.sideoutput</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.<span class="type">TimeCharacteristic</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.timestamps.<span class="type">BoundedOutOfOrdernessTimestampExtractor</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.function.<span class="type">ProcessAllWindowFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.<span class="type">Time</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.windows.<span class="type">TimeWindow</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 问题1：使用AllowedLateness 方法是不是会降低flink计算的吞吐量？ 是的</span></span><br><span class="line"><span class="comment"> * 问题2：直接watermark设置为5 不是也可以代替这一通操作嘛？ 不能代替，watermark设置为5的</span></span><br><span class="line"><span class="comment"> * 话，允许延迟5s，每次处理过去5s的窗口数据，延迟比较高，如果使用这通操作，每次处理过去2s的数</span></span><br><span class="line"><span class="comment"> * 据，实时性比较高，当有新的延迟数据，即时计算，对于计算实时性比较高的场景还得使用这一通操作</span></span><br><span class="line"><span class="comment"> * 问题3：watermark（5s）+滑动窗口（滑动间隔2s）能够实现这通计算？ 不行</span></span><br><span class="line"><span class="comment"> * 案例：每隔5s统计各个卡口最近5s的车流量（滑动窗口），计算实时性小于2（ps：当10s的数据来</span></span><br><span class="line"><span class="comment"> * 了，8s之前的数据必须处理完），允许数据延迟5s，数据延迟超过5s的数据放入到侧输出流中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 10000 hello</span></span><br><span class="line"><span class="comment"> * 11000 spark</span></span><br><span class="line"><span class="comment"> * 14000 flink</span></span><br><span class="line"><span class="comment"> * 15000 hadoop 此时窗口并不会计算，因为Watermark设为2s 此时的watermark是13000 窗口范围 10000-15000</span></span><br><span class="line"><span class="comment"> * 17000 sqoop 此时窗口会被计算 默认：窗口计算完毕，窗口数据全部会被清空</span></span><br><span class="line"><span class="comment"> * 12000 flume 此时窗口重新计算（10000-15000），因为开启了AllowedLateness 3s，当 watermark&gt;=window end+ AllowedLateness 3s 窗口数据及状态才会被清除掉，</span></span><br><span class="line"><span class="comment"> * 此时的watermark 是15000 20000 scala 此时上一个窗口（10000-15000）的数据及状态会被清空 12000 hdfs 此时窗口不会重新计算</span></span><br><span class="line"><span class="comment"> * 因为现在watermark是18000&gt;=15000+3000,12000数据是迟到 非常严重的数据，会被放入到侧输出流中</span></span><br><span class="line"><span class="comment"> * 本来10000-15000的窗口，在15000的时候会计算，但是由于Watermark 的原因，等待了2s 17000的时 候才会计算，</span></span><br><span class="line"><span class="comment"> * 又因为AllowedLateness 3s的原因，10000-15000的窗口会被保存3s（注意这是 eventtime时间语义），直到20000出现，才会被删除，</span></span><br><span class="line"><span class="comment"> * 所以在20000没有出现之前，凡是事件时间在 10000-15000的数据都会重新进行窗口计算 超过5s的数据，称之为迟到非常严重的数据，放入到侧输出流 5s以内的数据，</span></span><br><span class="line"><span class="comment"> * 称之为迟到不严重的数据，窗口重新计算</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Allowlatest</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setStreamTimeCharacteristic(<span class="type">TimeCharacteristic</span>.<span class="type">EventTime</span>)</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> stream = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    <span class="keyword">val</span> lateTag = <span class="keyword">new</span> <span class="type">OutputTag</span>[(<span class="type">Long</span>, <span class="type">String</span>)](<span class="string">&quot;late&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> value = stream.map(x =&gt; &#123;</span><br><span class="line">      <span class="keyword">val</span> strings = x.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">      (strings(<span class="number">0</span>).toLong, strings(<span class="number">1</span>))</span><br><span class="line">    &#125;).assignTimestampsAndWatermarks(<span class="keyword">new</span> <span class="type">BoundedOutOfOrdernessTimestampExtractor</span>[(<span class="type">Long</span>, <span class="type">String</span>)](<span class="type">Time</span>.seconds(<span class="number">2</span>)) &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">extractTimestamp</span></span>(element: (<span class="type">Long</span>, <span class="type">String</span>)): <span class="type">Long</span> = element._1</span><br><span class="line">    &#125;).timeWindowAll(<span class="type">Time</span>.seconds(<span class="number">5</span>)).allowedLateness(<span class="type">Time</span>.seconds(<span class="number">3</span>)).sideOutputLateData(lateTag).process(<span class="keyword">new</span> <span class="type">ProcessAllWindowFunction</span>[(<span class="type">Long</span>, <span class="type">String</span>), (<span class="type">Long</span>, <span class="type">String</span>), <span class="type">TimeWindow</span>] &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">process</span></span>(context: <span class="type">Context</span>, elements: <span class="type">Iterable</span>[(<span class="type">Long</span>, <span class="type">String</span>)], out: <span class="type">Collector</span>[(<span class="type">Long</span>, <span class="type">String</span>)]): <span class="type">Unit</span> = &#123;</span><br><span class="line">        println(context.window.getStart + <span class="string">&quot;---&quot;</span> + context.window.getEnd)</span><br><span class="line">        <span class="keyword">for</span> (elem &lt;- elements) &#123;</span><br><span class="line">          out.collect(elem)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    value.print(<span class="string">&quot;main&quot;</span>)</span><br><span class="line">    value.getSideOutput(lateTag).print(<span class="string">&quot;late&quot;</span>)</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="1-7-Flink关联维表实战"><a href="#1-7-Flink关联维表实战" class="headerlink" title="1.7.Flink关联维表实战"></a>1.7.Flink关联维表实战</h4><p>​    在Flink实际开发过程中，可能会遇到source 进来的数据，需要连接数据库里面的字段，再做后面的处理</p>
<p>比如，想要通过id获取对应的地区名字，这时候需要通过id查询地区维度表，获取具体的地区名对于不同的应用场景，关联维度表的方式不同</p>
<p>场景1：维度表信息基本不发生改变，或者发生改变的频率很低</p>
<p>实现方案：采用Flink提供的CachedFile</p>
<p>Flink提供了一个分布式缓存（CachedFile），类似于hadoop，可以使用户在并行函数中很方便的读取本地文件，并把它放在TaskManager节点中，防止task重复拉取。 此缓存的工作机制如下：</p>
<p>程序注册一个文件或者目录(本地或者远程文件系统，例如hdfs或者s3)，通过ExecutionEnvironment注册缓存文件并为它起一个名称。 当程序执行，Flink自动将文件或者目录复制到所有TaskManager节点的本地文件系统，仅会执行一次。用户可以通过这个指定的名称查找文件或者目录，然后从TaskManager节点的本地文件系统访问它</p>
<p>代码案例一</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.dimensiontable</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">RichMapFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.<span class="type">Configuration</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.&#123;<span class="type">StreamExecutionEnvironment</span>, _&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">FileUtils</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.collection.mutable</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">DimensionTableDemo1</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.registerCachedFile(<span class="string">&quot;D:\\tmp\\text01.txt&quot;</span>, <span class="string">&quot;id2city&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> socketStream = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    <span class="keyword">val</span> stream = socketStream.map(_.toInt)</span><br><span class="line">    stream.map(<span class="keyword">new</span> <span class="type">RichMapFunction</span>[<span class="type">Int</span>, <span class="type">String</span>] &#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">val</span> id2CityMap = <span class="keyword">new</span> mutable.<span class="type">HashMap</span>[<span class="type">Int</span>, <span class="type">String</span>]()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">open</span></span>(parameters: <span class="type">Configuration</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">        <span class="keyword">val</span> file = getRuntimeContext.getDistributedCache.getFile(<span class="string">&quot;id2city&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> str = <span class="type">FileUtils</span>.readFileUtf8(file)</span><br><span class="line">        <span class="keyword">val</span> strings = str.split(<span class="string">&quot;\r\n&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> (str &lt;- strings) &#123;</span><br><span class="line">          <span class="keyword">val</span> splits = str.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">          <span class="keyword">val</span> id = splits(<span class="number">0</span>).toInt</span><br><span class="line">          <span class="keyword">val</span> city = splits(<span class="number">1</span>)</span><br><span class="line">          id2CityMap.put(id, city)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map</span></span>(value: <span class="type">Int</span>): <span class="type">String</span> = &#123;</span><br><span class="line">        id2CityMap.getOrElse(value, <span class="string">&quot;not found city&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).print()</span><br><span class="line">    env.execute()</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在集群中查看对应TaskManager的log日志，发现注册的fifile会被拉取到各个TaskManager的工作目录区</p>
<p><img src="/img%5Cimage-20211027145131283.png" alt="image-20211027145131283"></p>
<p>代码案例二:对于维度表更新频率比较高并且对于查询维度表的实时性要求比较高</p>
<p>实现方案：使用定时器，定时加载外部配置文件或者数据库</p>
<p>注意此种方式key对应的value值只允许增加和修改,不允许删除(如果删除对应的是key删除前对应的value值)</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.dimensiontable</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.<span class="type">RichMapFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.configuration.<span class="type">Configuration</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.&#123;<span class="type">StreamExecutionEnvironment</span>, _&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.&#123;<span class="type">Timer</span>, <span class="type">TimerTask</span>&#125;</span><br><span class="line"><span class="keyword">import</span> scala.collection.mutable</span><br><span class="line"><span class="keyword">import</span> scala.io.<span class="type">Source</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">DimensionTableDemo2</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">val</span> stream = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    stream.map(<span class="keyword">new</span> <span class="type">RichMapFunction</span>[<span class="type">String</span>, <span class="type">String</span>] &#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">val</span> map = <span class="keyword">new</span> mutable.<span class="type">HashMap</span>[<span class="type">String</span>, <span class="type">String</span>]()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">open</span></span>(parameters: <span class="type">Configuration</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">        println(<span class="string">&quot;init data ...&quot;</span>)</span><br><span class="line">        query()</span><br><span class="line">        <span class="keyword">val</span> timer = <span class="keyword">new</span> <span class="type">Timer</span>(<span class="literal">true</span>)</span><br><span class="line">        timer.schedule(<span class="keyword">new</span> <span class="type">TimerTask</span> &#123;</span><br><span class="line">          <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">run</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">            query()</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//1s后，每隔2s执行一次</span></span><br><span class="line">        &#125;, <span class="number">1000</span>, <span class="number">2000</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">query</span></span>() = &#123;</span><br><span class="line">        <span class="keyword">val</span> source = <span class="type">Source</span>.fromFile(<span class="string">&quot;D:\\tmp\\text01.txt&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> iterator = source.getLines()</span><br><span class="line">        <span class="keyword">for</span> (elem &lt;- iterator) &#123;</span><br><span class="line">          <span class="keyword">val</span> vs = elem.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">          map.put(vs(<span class="number">0</span>), vs(<span class="number">1</span>))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">map</span></span>(key: <span class="type">String</span>): <span class="type">String</span> = &#123;</span><br><span class="line">        map.getOrElse(key, <span class="string">&quot;not found city&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果维度信息在配置文件中存储，那么还有一个解决方案，就是使用readFile读取文件，因为这个方法可以检测内容是否发生改变</p>
<p>代码案例三：对于维度表更新频率高并且对于查询维度表的实时性要求高</p>
<p>实现方案：管理员在修改配置文件的时候，需要将更改的信息同步值Kafka配置Topic中，然后将kafka的配置流信息变成广播流，广播到业务流的各个线程中</p>
<p><img src="/img%5Cimage-20211027150523831.png" alt="image-20211027150523831"></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz.dimensiontable</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.serialization.<span class="type">SimpleStringSchema</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.state.<span class="type">MapStateDescriptor</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.typeinfo.<span class="type">BasicTypeInfo</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.functions.co.<span class="type">BroadcastProcessFunction</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.&#123;<span class="type">StreamExecutionEnvironment</span>, _&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.kafka.<span class="type">FlinkKafkaConsumer</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.<span class="type">Collector</span></span><br><span class="line"><span class="keyword">import</span> org.apache.kafka.common.serialization.<span class="type">StringSerializer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.<span class="type">Properties</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">DimensionTableDemo3</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    <span class="comment">//设置连接kafka的配置信息</span></span><br><span class="line">    <span class="keyword">val</span> props = <span class="keyword">new</span> <span class="type">Properties</span>()</span><br><span class="line">    props.setProperty(<span class="string">&quot;bootstrap.servers&quot;</span>, <span class="string">&quot;hadoop001:9092&quot;</span>)</span><br><span class="line">    props.setProperty(<span class="string">&quot;group.id&quot;</span>, <span class="string">&quot;flink-kafka-001&quot;</span>)</span><br><span class="line">    props.setProperty(<span class="string">&quot;key.deserializer&quot;</span>, classOf[<span class="type">StringSerializer</span>].getName)</span><br><span class="line">    props.setProperty(<span class="string">&quot;value.deserializer&quot;</span>, classOf[<span class="type">StringSerializer</span>].getName)</span><br><span class="line">    <span class="keyword">val</span> consumer = <span class="keyword">new</span> <span class="type">FlinkKafkaConsumer</span>[<span class="type">String</span>](<span class="string">&quot;configure&quot;</span>, <span class="keyword">new</span> <span class="type">SimpleStringSchema</span>(), props)</span><br><span class="line">    <span class="comment">//从topic最开始的数据读取</span></span><br><span class="line">    <span class="comment">//consumer.setStartFromEarliest()</span></span><br><span class="line">    <span class="comment">// 从最新的数据开始读取</span></span><br><span class="line">    consumer.setStartFromLatest()</span><br><span class="line">    <span class="comment">//动态配置信息流</span></span><br><span class="line">    <span class="keyword">val</span> configureStream = env.addSource(consumer)</span><br><span class="line">    <span class="comment">//业务流</span></span><br><span class="line">    <span class="keyword">val</span> busStream = env.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9527</span>)</span><br><span class="line">    <span class="keyword">val</span> descriptor = <span class="keyword">new</span> <span class="type">MapStateDescriptor</span>[<span class="type">String</span>, <span class="type">String</span>](<span class="string">&quot;dynamicConfig&quot;</span>, <span class="type">BasicTypeInfo</span>.<span class="type">STRING_TYPE_INFO</span>, <span class="type">BasicTypeInfo</span>.<span class="type">STRING_TYPE_INFO</span>)</span><br><span class="line">    <span class="comment">//设置广播流的数据描述信息</span></span><br><span class="line">    <span class="keyword">val</span> broadcastStream = configureStream.broadcast(descriptor)</span><br><span class="line">    <span class="comment">//connect关联业务流与配置信息流，broadcastStream流中的数据会广播到下游的各个线程中</span></span><br><span class="line">    busStream.connect(broadcastStream).process(<span class="keyword">new</span> <span class="type">BroadcastProcessFunction</span>[<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>] &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processElement</span></span>(line: <span class="type">String</span>, ctx: <span class="type">BroadcastProcessFunction</span>[<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>]#<span class="type">ReadOnlyContext</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">        <span class="keyword">val</span> broadcast = ctx.getBroadcastState(descriptor)</span><br><span class="line">        <span class="keyword">val</span> city = broadcast.get(line)</span><br><span class="line">        <span class="keyword">if</span> (city == <span class="literal">null</span>) &#123;</span><br><span class="line">          out.collect(<span class="string">&quot;not found city&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          out.collect(city)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//kafka中配置流信息，写入到广播流中</span></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">processBroadcastElement</span></span>(line: <span class="type">String</span>, ctx: <span class="type">BroadcastProcessFunction</span>[<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>]#<span class="type">Context</span>, out: <span class="type">Collector</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">        <span class="keyword">val</span> broadcast = ctx.getBroadcastState(descriptor)</span><br><span class="line">        <span class="comment">//kafka中的数据</span></span><br><span class="line">        <span class="keyword">val</span> elems = line.split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line">        broadcast.put(elems(<span class="number">0</span>), elems(<span class="number">1</span>))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;).print()</span><br><span class="line">    env.execute()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/01/02/Flink%E5%9F%BA%E7%A1%80-Window-Watermark/" data-id="ckw5znxwa0005w9gh3hn38jif" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-Flink-API开篇" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2020/01/01/Flink-API%E5%BC%80%E7%AF%87/">Flink-API开篇</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/01/Flink-API%E5%BC%80%E7%AF%87/" class="article-date">
  <time datetime="2020-01-01T07:04:00.000Z" itemprop="datePublished">2020-01-01</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
      <h4 id="1-1-Flink-API介绍"><a href="#1-1-Flink-API介绍" class="headerlink" title="1.1.Flink API介绍"></a>1.1.Flink API介绍</h4><p>Flink提供了不同的抽象级别以开发流式或者批处理应用程序</p>
<p><img src="/img/image-20211102160941064.png" alt="image-20211102160941064"></p>
<ul>
<li><strong>Stateful Stream Processing</strong> 最低级的抽象接口是状态化的数据流接口（statefulstreaming）。这个接口是通过 ProcessFunction 集成到 DataStream API 中的。该接口允许用户自由的处理来自一个或多个流中的事件，并使用一致的容错状态。另外，用户也可以通过注册event time 和 processing time 处理回调函数的方法来实现复杂的计算</li>
<li><strong>DataStream/DataSet API</strong> DataStream / DataSet API 是 Flink 提供的核心 API ，DataSet 处理有界的数据集，DataStream 处理有界或者无界的数据流。用户可以通过各种方法（map /flatmap / window / keyby / sum / max / min / avg / join 等）将数据进行转换 / 计算</li>
<li><strong>Table API</strong> Table API 提供了例如 select、project、join、group-by、aggregate 等操作，使用起来却更加简洁,可以在表与 DataStream/DataSet 之间无缝切换，也允许程序将 Table API 与DataStream 以及 DataSet 混合使用</li>
<li><strong>SQL</strong> Flink 提供的最高层级的抽象是 SQL 。这一层抽象在语法与表达能力上与 Table API 类似。SQL 抽象与 Table API 交互密切，同时 SQL 查询可以直接在 Table API 定义的表上执行</li>
</ul>
<h4 id="1-2-Dataflows数据流图"><a href="#1-2-Dataflows数据流图" class="headerlink" title="1.2.Dataflows数据流图"></a>1.2.Dataflows数据流图</h4><p>在Flink的世界观中，一切都是数据流，所以对于批计算来说，那只是流计算的一个特例而已</p>
<p>Flink Dataflows是由三部分组成，分别是：source、transformation、sink结束</p>
<p>source数据源会源源不断的产生数据</p>
<p>transformation将产生的数据进行各种业务逻辑的数据处理</p>
<p>最终由sink输出到外部（console、kafka、redis、DB……）</p>
<p>基于Flink开发的程序都能够映射成一个Dataflows</p>
<p><img src="/img%5Cimage-20211102161450067.png" alt="image-20211102161450067"></p>
<p>当source数据源的数量比较大或计算逻辑相对比较复杂的情况下，需要提高并行度来处理数据，采用并行数据流</p>
<p>通过设置不同算子的并行度 source并行度设置为2 map也是2…. 代表会启动多个并行的线程来处理数据</p>
<p><img src="/img%5Cimage-20211102161638405.png" alt="image-20211102161638405"></p>
<h4 id="1-3-开发环境配置"><a href="#1-3-开发环境配置" class="headerlink" title="1.3.开发环境配置"></a>1.3.开发环境配置</h4><p>每个 Flink 应用都需要依赖一组 Flink 类库。Flink 应用至少需要依赖 Flink APIs。许多应用还会额外依赖连接器类库(比如 Kafka、Cassandra 等)。 当用户运行 Flink 应用时(无论是在 IDEA 环境下进行测试，还是部署在分布式环境下)，运行时类库都必须可用</p>
<p>开发工具：IntelliJ IDEA</p>
<p>配置开发Maven依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-scala_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-scala_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>注意点：</p>
<ul>
<li>如果要将程序打包提交到集群运行，打包的时候不需要包含这些依赖，因为集群环境已经包含了这些依赖，此时依赖的作用域应该设置为provided provided</li>
<li>Flink 应用在 IntelliJ IDEA 中运行，这些 Flink 核心依赖的作用域需要设置为 <em>compile</em> 而不是<em>provided</em> 。 否则 IntelliJ 不会添加这些依赖到 classpath，会导致应用运行时抛出NoClassDefFountError 异常</li>
</ul>
<p>添加打包插件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-shade-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goal</span>&gt;</span>shade<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">artifactSet</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>com.google.code.findbugs:jsr305<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>org.slf4j:*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>log4j:*<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">artifactSet</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">filters</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">filter</span>&gt;</span> <span class="comment">&lt;!--不要拷贝 META-INF 目录下的签名， 否则会引起 SecurityExceptions 。 --&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">artifact</span>&gt;</span>*:*<span class="tag">&lt;/<span class="name">artifact</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.SF<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.DSA<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">exclude</span>&gt;</span>META-INF/*.RSA<span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">filters</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">transformers</span>&gt;</span></span><br><span class="line">                            &lt;transformer</span><br><span class="line">                                    implementation=&quot;org.apache.maven.plugins.shade.resource.ManifestResourceTransfor mer&quot;&gt;</span><br><span class="line">                                <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>my.programs.main.clazz<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">transformer</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">transformers</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="WordCount批计算程序"><a href="#WordCount批计算程序" class="headerlink" title="WordCount批计算程序"></a>WordCount批计算程序</h5><p>批计算：统计HDFS文件单词出现的次数</p>
<p>读取HDFS数据需要添加Hadoop依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>WordCount代码：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> env = <span class="type">ExecutionEnvironment</span>.getExecutionEnvironment <span class="keyword">val</span> initDS: <span class="type">DataSet</span>[<span class="type">String</span>] = env.readTextFile(<span class="string">&quot;hdfs://node01:9000/flink/data/wc&quot;</span>) <span class="keyword">val</span> restDS: <span class="type">AggregateDataSet</span>[(<span class="type">String</span>, <span class="type">Int</span>)] = initDS.flatMap(_.split(<span class="string">&quot; &quot;</span>)).map((_,<span class="number">1</span>)).groupBy(<span class="number">0</span>).sum(<span class="number">1</span>) restDS.print()</span><br></pre></td></tr></table></figure>

<h5 id="WordCount流计算程序"><a href="#WordCount流计算程序" class="headerlink" title="WordCount流计算程序"></a>WordCount流计算程序</h5><p>流计算：统计数据流中，单词出现的次数</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xyz</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala.<span class="type">StreamExecutionEnvironment</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.scala._</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Test01</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="comment">//准备环境</span></span><br><span class="line">    <span class="comment">/** * createLocalEnvironment 创建一个本地执行的环境 local * createLocalEnvironmentWithWebUI 创建一个本地执行的环境 同时还开启Web UI的查看 端口 8081 * getExecutionEnvironment 根据你执行的环境创建上下文，比如local cluster */</span></span><br><span class="line">    <span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">    env.setParallelism(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">/** * DataStream：一组相同类型的元素 组成的数据流 */</span></span><br><span class="line">    <span class="keyword">val</span> initStream: <span class="type">DataStream</span>[<span class="type">String</span>] = env.socketTextStream(<span class="string">&quot;node01&quot;</span>, <span class="number">8888</span>)</span><br><span class="line">    <span class="keyword">val</span> wordStream = initStream.flatMap(_.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line">    <span class="keyword">val</span> pairStream = wordStream.map((_, <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">val</span> keyByStream = pairStream.keyBy(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">val</span> restStream = keyByStream.sum(<span class="number">1</span>)</span><br><span class="line">    restStream</span><br><span class="line">      .print()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 6&gt; (msb,1)</span></span><br><span class="line"><span class="comment">     * 1&gt; (,,1)</span></span><br><span class="line"><span class="comment">     * 3&gt; (hello,1)</span></span><br><span class="line"><span class="comment">     * 3&gt; (hello,2)</span></span><br><span class="line"><span class="comment">     * 6&gt; (msb,2)</span></span><br><span class="line"><span class="comment">     * 默认就是有状态的计算</span></span><br><span class="line"><span class="comment">     * 6&gt; 代表是哪一个线程处理的 ** 相同的数据一定是由某一个thread处理 </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">//启动Flink 任务</span></span><br><span class="line">    env.execute(<span class="string">&quot;first flink job&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="1-4-WordCount-Dataflows算子链"><a href="#1-4-WordCount-Dataflows算子链" class="headerlink" title="1.4.WordCount Dataflows算子链"></a>1.4.WordCount Dataflows算子链</h4><p>为了更高效地分布式执行，Flink会尽可能地将operator的subtask链接（chain）在一起形成task。每个task在一个线程中执行。将operators链接成task是非常有效的优化：它能减少线程之间的切换，减少消息的序列化/反序列化，减少数据在缓冲区的交换，减少了延迟的同时提高整体的吞吐量</p>
<h5 id="Flink任务调度规则"><a href="#Flink任务调度规则" class="headerlink" title="Flink任务调度规则"></a>Flink任务调度规则</h5><ul>
<li>不同Task下的subtask分到同一个TaskSlot，提高数据传输效率</li>
<li>相同Task下的subtask不会分到同一个TaskSlot，充分利用集群资源</li>
</ul>
<p><img src="/img%5Cimage-20211102164126751.png" alt="image-20211102164126751"></p>
<p><img src="/img%5Cimage-20211102164148028.png" alt="image-20211102164148028"></p>
<h4 id="1-5-Flink并行度设置方式"><a href="#1-5-Flink并行度设置方式" class="headerlink" title="1.5.Flink并行度设置方式"></a>1.5.Flink并行度设置方式</h4><ol>
<li><p>在算子上设置</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> wordStream = initStream.flatMap(_.split(<span class="string">&quot; &quot;</span>)).setParallelism(<span class="number">2</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>在上下文环境中设置</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> env = <span class="type">StreamExecutionEnvironment</span>.getExecutionEnvironment</span><br><span class="line">env.setParallelism(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>client提交Job时设置</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flink run -c com.msb.stream.<span class="type">WordCount</span> -p <span class="number">3</span> <span class="type">StudyFlink</span><span class="number">-1.0</span>-<span class="type">SNAPSHOT</span>.jar</span><br></pre></td></tr></table></figure></li>
<li><p>在flink-conf.yaml配置文件中设置</p>
</li>
</ol>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parallelism.<span class="keyword">default</span>: <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>这四种设置并行度的方式，优先级依次递减</strong></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/01/01/Flink-API%E5%BC%80%E7%AF%87/" data-id="ckw5znxw80002w9gh9b27hzd6" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-Flink-部署" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2020/01/01/Flink-%E9%83%A8%E7%BD%B2/">Flink-部署</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2020/01/01/Flink-%E9%83%A8%E7%BD%B2/" class="article-date">
  <time datetime="2020-01-01T05:55:00.000Z" itemprop="datePublished">2020-01-01</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
      <h3 id="1-Flink入门篇"><a href="#1-Flink入门篇" class="headerlink" title="1.Flink入门篇"></a>1.Flink入门篇</h3><p>官网下载地址:</p>
<p><a target="_blank" rel="noopener" href="https://flink.apache.org/downloads.html#apache-flink-1133">https://flink.apache.org/downloads.html#apache-flink-1133</a></p>
<h4 id="1-1-Flink基本架构"><a href="#1-1-Flink基本架构" class="headerlink" title="1.1.Flink基本架构"></a>1.1.Flink基本架构</h4><p>Flink系统架构中包含了两个角色，分别是JobManager和TaskManager，是一个典型的Master-Slave架构。</p>
<p>JobManager相当于是Master，TaskManager相当于是Slave</p>
<p><img src="/img%5Cimage-20211102144230466.png" alt="image-20211102144230466"></p>
<h6 id="JobManager（JVM进程）作用"><a href="#JobManager（JVM进程）作用" class="headerlink" title="JobManager（JVM进程）作用"></a>JobManager（JVM进程）作用</h6><p>JobManager负责整个集群的资源管理与任务管理，在一个集群中只能由一个正在工作（active）的JobManager，如果HA集群，那么其他JobManager一定是standby状态</p>
<p><strong>资源调度</strong></p>
<ul>
<li>集群启动，TaskManager会将当前节点的资源信息注册给JobManager，所有TaskManager全部注册完毕，集群启动成功，此时JobManager就掌握整个集群的资源情况</li>
<li>client提交Application给JobManager，JobManager会根据集群中的资源情况，为当前的Application分配TaskSlot资源</li>
</ul>
<p><strong>任务调度</strong></p>
<ul>
<li>根据各个TaskManager节点上的资源分发task到TaskSlot中运行</li>
<li>Job执行过程中，JobManager会根据设置的触发策略触发checkpoint，通知TaskManager开始checkpoint</li>
<li>任务执行完毕，JobManager会将Job执行的信息反馈给client，并且释放TaskManager资源</li>
</ul>
<h6 id="TaskManager（JVM进程）作用"><a href="#TaskManager（JVM进程）作用" class="headerlink" title="TaskManager（JVM进程）作用"></a>TaskManager（JVM进程）作用</h6><ul>
<li>负责当前节点上的任务运行及当前节点上的资源管理，TaskManager资源通过TaskSlot进行了划分，每个TaskSlot代表的是一份固定资源。例如，具有三个 slots 的 TaskManager 会将其管理的内存资源分成三等份给每个 slot。 划分资源意味着 subtask 之间不会竞争内存资源，但是也意味着它们只拥有固定的资源。注意这里并没有 CPU 隔离，当前 slots 之间只是划分任务的内存资源</li>
<li>负责TaskManager之间的数据交换</li>
</ul>
<h6 id="client客户端"><a href="#client客户端" class="headerlink" title="client客户端"></a>client客户端</h6><p>负责将当前的任务提交给JobManager，提交任务的常用方式：命令提交、web页面提交。获取任务的执行信息</p>
<h5 id="Flink的特点和优势"><a href="#Flink的特点和优势" class="headerlink" title="Flink的特点和优势"></a>Flink的特点和优势</h5><p>1、同时支持高吞吐、低延迟、高性能</p>
<p>2、支持事件时间（Event Time）概念，结合Watermark处理乱序数据</p>
<p>3、支持有状态计算，并且支持多种状态 内存、文件、RocksDB</p>
<p>4、支持高度灵活的窗口（Window）操作 time、count、session</p>
<p>5、基于轻量级分布式快照（CheckPoint）实现的容错 保证exactly-once语义</p>
<p>6、基于JVM实现独立的内存管理</p>
<p>7、Save Points（保存点）</p>
<h4 id="1-2-Standalone集群安装-amp-测试"><a href="#1-2-Standalone集群安装-amp-测试" class="headerlink" title="1.2.Standalone集群安装&amp;测试"></a>1.2.Standalone集群安装&amp;测试</h4><p>Standalone是独立部署模式，它不依赖其他平台，不依赖任何的资源调度框架</p>
<p>Standalone集群是由JobManager、TaskManager两个JVM进程组成</p>
<p>集群角色划分</p>
<p><img src="/img%5Cimage-20211028174216751.png" alt="image-20211028174216751"></p>
<p><strong>安装步骤</strong></p>
<p> 1.官网下载Flink安装包</p>
<p>Apache Flink® 1.10.0 is our latest stable release.现在最稳定的是1.10.0，不建议采用这个版</p>
<p>本，刚从1.9升级到1.10，会存在一些bug，不建议采用小版本号为0的安装包，所以我们建议使用</p>
<p>1.9.2版本下载链接:<a target="_blank" rel="noopener" href="https://mirrors.tuna.tsinghua.edu.cn/apache/flflink/flflink-1.9.2/flflink-1.9.2-bin-scala_2">https://mirrors.tuna.tsinghua.edu.cn/apache/flflink/flflink-1.9.2/flflink-1.9.2-bin-scala_2</a>.</p>
<p>11.tgz</p>
<ol start="2">
<li><p>安装包上传到node01节点</p>
</li>
<li><p>解压、修改配置文件</p>
</li>
</ol>
<p>解压：tar -zxf flink-1.9.2-bin-scala_2.11.tgz</p>
<p>修改flink-conf.yaml配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jobmanager.rpc.address: node01 JobManager地址 </span><br><span class="line">jobmanager.rpc.port: 6123 JobManagerRPC通信端口 </span><br><span class="line">jobmanager.heap.size: 1024m JobManager所能使用的堆内存大小</span><br><span class="line">taskmanager.heap.size: 1024m TaskManager所能使用的堆内存大小</span><br><span class="line">taskmanager.numberOfTaskSlots: 2 TaskManager管理的TaskSlot个数，依据当前物理机的 核心数来配置，一般预留出一部分核心（25%）给系统及其他进程使用，一个slot对应一个core。如果 core支持超线程，那么slot个数*2</span><br><span class="line">rest.port: 8081 指定WebUI的访问端口</span><br></pre></td></tr></table></figure>

<p>修改slaves配置文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">node02</span><br><span class="line">node03</span><br><span class="line">node04</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>同步安装包到其他的节点</li>
</ol>
<p>同步到node02 scp -r flflink-1.9.2 node02: pwd</p>
<p>同步到node03 scp -r flflink-1.9.2 node03: pwd</p>
<p>同步到node04 scp -r flflink-1.9.2 node04: pwd </p>
<ol start="5">
<li>node01配置环境变量</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.bashrc</span><br><span class="line">export FLINK_HOME=/opt/software/flink/flink-1.9.2</span><br><span class="line">export PATH=$PATH:$FLINK_HOME/bin</span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>启动standalone集群</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">启动集群：start-cluster.sh</span><br><span class="line">关闭集群：stop-cluster.sh</span><br><span class="line">http://node01:8081/ 可通过rest.port参数自定义端口</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>查看Flink Web UI页面</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://node01:8081/ 可通过rest.port参数自定义端口</span><br></pre></td></tr></table></figure>



<p><img src="/img%5Cimage-20211028175200869.png" alt="image-20211028175200869"></p>
<p>提交Job到standalone集群</p>
<p>常用提交任务的方式有两种，分别是命令提交和Web页面提交</p>
<ol>
<li>命令提交</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flink run -c com.msb.stream.WordCount StudyFlink-1.0-SNAPSHOT.jar</span><br><span class="line"></span><br><span class="line">-c 指定主类</span><br><span class="line">-d 独立运行、后台运行</span><br><span class="line">-p 指定并行度</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Web页面提交</li>
</ol>
<p>在Web中指定Jar包的位置、主类路径、并行数等</p>
<p>web.submit.enable: true一定是true，否则不支持Web提交Application</p>
<p><img src="/img%5Cimage-20211028175451364.png" alt="image-20211028175451364"></p>
<ol start="3">
<li>启动scala-shell测试</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start-scala-shell.sh remote &lt;hostname&gt; &lt;portnumber&gt;</span><br></pre></td></tr></table></figure>

<h4 id="1-3-Standalone-HA集群安装-amp-测试"><a href="#1-3-Standalone-HA集群安装-amp-测试" class="headerlink" title="1.3.Standalone HA集群安装&amp;测试"></a>1.3.Standalone HA集群安装&amp;测试</h4><p>JobManager协调每个flink任务部署,它负责调度和资源管理</p>
<p>默认情况下，每个flink集群只有一个JobManager，这将导致一个单点故障(SPOF single-point-of-failure)：如果JobManager挂了，则不能提交新的任务，并且运行中的程序也会失败。</p>
<p>使用JobManager HA，集群可以从JobManager故障中恢复，从而避免SPOF</p>
<p>Standalone模式（独立模式）下JobManager的高可用性的基本思想是，任何时候都有一个 Active JobManager ，并且多个Standby JobManagers 。 Standby JobManagers可以在Master JobManager挂掉的情况下接管集群成为Master JobManager。 这样保证了没有单点故障，一旦某一个Standby JobManager接管集群，程序就可以继续运行。 Standby JobManager和Active JobManager实例之间没有明确区别。 每个JobManager可以成为Active或Standby节点</p>
<p><img src="/img%5Cimage-20211102145556454.png" alt="image-20211102145556454"></p>
<p><strong>集群角色划分</strong></p>
<p><img src="/img%5Cimage-20211102145819490.png" alt="image-20211102145819490"></p>
<p><strong>安装步骤</strong></p>
<ol>
<li>修改配置文件conf/flflink-conf.yaml</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">high-availability: zookeeper</span><br><span class="line">high-availability.storageDir: hdfs://node01:9000/flink/ha/ #保存JobManager恢复 所需要的所有元数据信息 </span><br><span class="line">high-availability.zookeeper.quorum: node01:2181,node02:2181,node03:2181 #zookeeper地址</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改配置文件conf/masters</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">node01:8081</span><br><span class="line">node02:8081</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>同步文件到各个节点</p>
</li>
<li><p>下载支持Hadoop插件并且拷贝到各个节点的安装包的lib目录下</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下载地址：</span><br><span class="line">https://repo.maven.apache.org/maven2/org/apache/flink/flink-shaded-hadoop-2-</span><br><span class="line">uber/2.6.5-10.0/flink-shaded-hadoop-2-uber-2.6.5-10.0.jar</span><br></pre></td></tr></table></figure>

<p>HA集群测试</p>
<p><a target="_blank" rel="noopener" href="http://node01:8081/">http://node01:8081/</a></p>
<p><a target="_blank" rel="noopener" href="http://node02:8081/">http://node02:8081/</a></p>
<p>两个页面一模一样 此版本存在bug</p>
<h4 id="1-4-Flink-on-Yarn"><a href="#1-4-Flink-on-Yarn" class="headerlink" title="1.4.Flink on Yarn"></a>1.4.Flink on Yarn</h4><p>Flink on Yarn是依托Yarn资源管理器，现在很多分布式任务都可以支持基于Yarn运行，这是在企业中使用最多的方式。Why？ </p>
<p>（1）基于Yarn的运行模式可以充分使用集群资源，Spark on Yarn、MapReduce on Yarn、Flink on</p>
<p>Yarn等 多套计算框架都可以基于Yarn运行，充分利用集群资源</p>
<p>（2）基于Yarn的运行模式降低维护成本</p>
<p><strong>运行流程</strong></p>
<p><img src="/img%5Cimage-20211102150503236.png" alt="image-20211102150503236"></p>
<ol>
<li><p> 每当创建一个新flink的yarn session的时候，客户端会首先检查要请求的资源(containers和memory)是否可用。然后，将包含flflink相关的jar包盒配置上传到HDFS</p>
</li>
<li><p>客户端会向ResourceManager申请一个yarn container 用以启动ApplicationMaster。由于客户端已经将配置和jar文件上传到HDFS，ApplicationMaster将会下载这些jar和配置，然后启动成功</p>
</li>
<li><p>JobManager和AM运行于同一个container</p>
</li>
<li><p>AM开始申请启动Flink TaskManager的containers，这些container会从HDFS上下载jar文件和已修改的配置文件。一旦这些步骤完成，flink就可以接受任务了</p>
</li>
</ol>
<h5 id="Flink-on-Yarn两种运行模式"><a href="#Flink-on-Yarn两种运行模式" class="headerlink" title="Flink on Yarn两种运行模式"></a>Flink on Yarn两种运行模式</h5><p>解脱了JobManager的压力 RM做资源管理 JobManager只负责任务管理</p>
<ul>
<li>yarn seesion(Start a long-running Flink cluster on YARN)这种方式是在yarn中先启动Flink集群，然后再提交作业，这个Flink集群一直停留再yarn中，一直占据了yarn集群的资源（只是JobManager会一直占用，没有Job运行TaskManager并不会运行）,不管有没有任务运行。这种方式能够降低任务的启动时间</li>
<li>Run a Flink job on YARN 每次提交一个Flink任务的时候，先去yarn中申请资源启动JobManager和TaskManager，然后在当前集群中运行，任务执行完毕，集群关闭。任务之间互相独立，互不影响，可以最大化的使用集群资源，但是每个任务的启动时间变长了</li>
</ul>
<p><strong>配置两种运行模式</strong></p>
<h6 id="yarn-seesion模式配置"><a href="#yarn-seesion模式配置" class="headerlink" title="yarn seesion模式配置"></a>yarn seesion模式配置</h6><ul>
<li>Flink on Yarn依赖Yarn集群和HDFS集群，启动Yarn、HDFS集群 start-all.sh</li>
<li>下载支持Hadoop插件并且拷贝到各个节点的安装包的lib目录下:下载地址：<a target="_blank" rel="noopener" href="https://repo.maven.apache.org/maven2/org/apache/flflink/flflink-shaded-hadoop-2-uber/2.6.5-10.0/flflink-shaded-hadoop-2-uber-2.6.5-10.0.jar">https://repo.maven.apache.org/maven2/org/apache/flflink/flflink-shaded-hadoop-2-uber/2.6.5-10.0/flflink-shaded-hadoop-2-uber-2.6.5-10.0.jar</a></li>
<li>在yarn中启动Flink集群</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">启动：yarn-session.sh -n 3 -s 3 -nm flink-session -d -q </span><br><span class="line">关闭：yarn application -kill applicationId</span><br><span class="line"></span><br><span class="line">yarn-session选项:</span><br><span class="line">-n,--container &lt;arg&gt;：在yarn中启动container的个数，实质就是TaskManager的个数</span><br><span class="line">-s,--slots &lt;arg&gt;：每个TaskManager管理的Slot个数</span><br><span class="line">-nm,--name &lt;arg&gt;:给当前的yarn-session(Flink集群)起一个名字</span><br><span class="line">-d,--detached:后台独立模式启动，守护进程</span><br><span class="line">-tm,--taskManagerMemory &lt;arg&gt;：TaskManager的内存大小 单位：MB</span><br><span class="line">-jm,--jobManagerMemory &lt;arg&gt;：JobManager的内存大小 单位：MB</span><br><span class="line">-q,--query：显示yarn集群可用资源（内存、core）</span><br></pre></td></tr></table></figure>

<p><img src="/img%5Cimage-20211102154806981.png" alt="image-20211102154806981"></p>
<ul>
<li>提交Flink Job到yarn-session集群中运行</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">flink run -c com.msb.stream.WordCount -yid application_1586794520478_0007 ~/StudyFlink-1.0-SNAPSHOT.jar</span><br><span class="line"></span><br><span class="line">yid：指定yarn-session的ApplicationID</span><br><span class="line">不使用yid也可以，因为在启动yarn-session的时候，在tmp临时目录下已经产生了一个隐藏小文件 </span><br><span class="line">[root@node01 bin]# vim /tmp/.yarn-properties-root</span><br><span class="line"><span class="meta">#</span><span class="bash">Generated YARN properties file</span></span><br><span class="line"><span class="meta">#</span><span class="bash">Mon Apr 13 23:39:43 CST 2020</span></span><br><span class="line">parallelism=9</span><br><span class="line">dynamicPropertiesString=</span><br><span class="line">applicationID=application_1586791887356_0001</span><br></pre></td></tr></table></figure>

<h6 id="Run-a-Flink-job-on-YARN模式配置"><a href="#Run-a-Flink-job-on-YARN模式配置" class="headerlink" title="Run a Flink job on YARN模式配置"></a>Run a Flink job on YARN模式配置</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">flink run -m yarn-cluster -yn 3 -ys 3 -ynm flink-job -c com.msb.stream.WordCount ~/StudyFlink-1.0-SNAPSHOT.jar</span><br><span class="line">-yn,--container &lt;arg&gt; 表示分配容器的数量，也就是TaskManager的数量。</span><br><span class="line">-d,--detached：设置在后台运行。</span><br><span class="line">-yjm,--jobManagerMemory&lt;arg&gt;:设置JobManager的内存，单位是MB。</span><br><span class="line">-ytm，--taskManagerMemory&lt;arg&gt;:设置每个TaskManager的内存，单位是MB。</span><br><span class="line">-ynm,--name:给当前Flink application在Yarn上指定名称。</span><br><span class="line">-yq,--query：显示yarn中可用的资源（内存、cpu核数）</span><br><span class="line">-yqu,--queue&lt;arg&gt; :指定yarn资源队列</span><br><span class="line">-ys,--slots&lt;arg&gt; :每个TaskManager使用的Slot数量。</span><br></pre></td></tr></table></figure>

<h5 id="Flink-on-YARN-HA集群安装-amp-测试"><a href="#Flink-on-YARN-HA集群安装-amp-测试" class="headerlink" title="Flink on YARN HA集群安装&amp;测试"></a>Flink on YARN HA集群安装&amp;测试</h5><p>无论以什么样的模式提交Application到Yarn中运行，都会启动一个yarn-session(Flink 集群)，依然是由JobManager和TaskManager组成，那么JobManager节点如果宕机，那么整个Flink集群就不会正常运转，所以接下来搭建Flink on YARN HA集群</p>
<p><strong>安装步骤</strong></p>
<ul>
<li>修改Hadoop安装包下的yarn-site.xml文件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.resourcemanager.am.max-attempts<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>10<span class="tag">&lt;/<span class="name">value</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span> </span><br><span class="line">    The maximum number of application master execution attempts AppMaster最大 重试次数</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>修改Flink安装包下的flin-conf.yaml文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">high-availability: zookeeper</span><br><span class="line">high-availability.storageDir: hdfs://node01:9000/flink/ha/</span><br><span class="line">high-availability.zookeeper.quorum: node01:2181,node02:2181,node03:2181</span><br></pre></td></tr></table></figure>

<p><strong>HA集群测试</strong></p>
<p>两种模式都可以测试，因为不管哪种模式都会启动yarn-session</p>
<p>yarn-session模式测试</p>
<ul>
<li>启动yarn-session</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn-session.sh -n 3 -s 3 -nm flink-session -d</span><br></pre></td></tr></table></figure>

<p>通过yarn web ui 找到ApplicationMaster，发现此时的JobManager是在node02启动，现在kill掉 JobManager进程 kill -9 进程号</p>
<p><img src="/img%5Cimage-20211102155717734.png" alt="image-20211102155717734"></p>
<p><img src="/img%5Cimage-20211102155747764.png" alt="image-20211102155747764"></p>
<p><img src="/img%5Cimage-20211102155805687.png" alt="image-20211102155805687"></p>
<ul>
<li>再次查看 发现JobManager切换到node03</li>
</ul>
<p><img src="/img%5Cimage-20211102155850049.png" alt="image-20211102155850049"></p>
<ul>
<li>查看node03日志</li>
</ul>
<p><img src="/img%5Cimage-20211102155924638.png" alt="image-20211102155924638"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-04-08 22:21:36,044 INFO org.apache.flink.yarn.YarnResourceManager - ResourceManager akka.tcp://flink@node03:60599/user/resourcemanager was granted leadership with fencing token 94c94c3d68ed799374303fad7447418b</span><br></pre></td></tr></table></figure>

<p>取消job 开始Run a Flink job on YARN模式测试</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flink list</span><br><span class="line">flink canel id</span><br></pre></td></tr></table></figure>



<h5 id="Run-a-Flink-job-on-YARN模式测试"><a href="#Run-a-Flink-job-on-YARN模式测试" class="headerlink" title="Run a Flink job on YARN模式测试"></a>Run a Flink job on YARN模式测试</h5><ul>
<li><p>提交job</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flink run -m yarn-cluster -yn 3 -ys 3 -ynm flink-job -c com.msb.stream.WordCount ~/StudyFlink-1.0-SNAPSHOT.jar</span><br></pre></td></tr></table></figure></li>
<li><p>停掉JobManager 观察</p>
</li>
<li><p>测试完毕，取消job</p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn application -kill applicationId</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/01/01/Flink-%E9%83%A8%E7%BD%B2/" data-id="ckw5znxw90003w9ghaheyc4pf" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-scala基础02" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2019/07/05/scala%E5%9F%BA%E7%A1%8002/">scala基础02</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2019/07/05/scala%E5%9F%BA%E7%A1%8002/" class="article-date">
  <time datetime="2019-07-05T02:38:00.000Z" itemprop="datePublished">2019-07-05</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
      <h3 id="1-高阶函数"><a href="#1-高阶函数" class="headerlink" title="1.高阶函数"></a>1.高阶函数</h3><h4 id="1-1-基础使用"><a href="#1-1-基础使用" class="headerlink" title="1.1.基础使用"></a>1.1.基础使用</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//  函数定义方式一</span></span><br><span class="line"><span class="comment">//  val/var 函数名称 = （输入参数列表） =&gt; &#123;函数体&#125;</span></span><br><span class="line"><span class="keyword">val</span> f1 = (a: <span class="type">Int</span>, b: <span class="type">Int</span>) =&gt; a + b</span><br><span class="line">println(f1(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//  函数定义方式二</span></span><br><span class="line"><span class="comment">//  val/var 函数名称:(输入参数列表) =&gt; 返回值类型 = (输入参数的饮用) =&gt;&#123;函数体&#125;</span></span><br><span class="line"><span class="keyword">val</span> f2: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span> = (a: <span class="type">Int</span>, b: <span class="type">Int</span>) =&gt; a + b</span><br><span class="line"><span class="keyword">val</span> f3: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span> = (a, b) =&gt; a + b</span><br><span class="line">println(f3(<span class="number">2</span>, <span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法的定义一</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sayHello</span></span>(name: <span class="type">String</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">  println(<span class="string">s&quot;<span class="subst">$name</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法赋值给变量</span></span><br><span class="line"><span class="keyword">val</span> sayHelloFunc = sayHello _</span><br><span class="line">sayHelloFunc(<span class="string">&quot;zhangsan&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 高阶函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cal</span></span>(a: <span class="type">Int</span>, b: <span class="type">Int</span>, op: ((<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span>)): <span class="type">Int</span> = &#123;</span><br><span class="line">  op(a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span></span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>) = x + y</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mulit</span></span>(x: <span class="type">Int</span>, y: <span class="type">Int</span>) = x * y</span><br><span class="line"></span><br><span class="line">println(cal(<span class="number">2</span>, <span class="number">3</span>, mulit))</span><br><span class="line">println(cal(<span class="number">2</span>, <span class="number">3</span>, _ + _))</span><br><span class="line"></span><br><span class="line"><span class="comment">// currying  柯里化 spark SQL 用的多</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum1</span></span>(a: <span class="type">Int</span>, b: <span class="type">Int</span>) = a + b</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum2</span></span>(a: <span class="type">Int</span>)(b: <span class="type">Int</span>) = a + b</span><br><span class="line"></span><br><span class="line">println(sum1(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">println(sum2(<span class="number">1</span>)(<span class="number">2</span>))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="1-2-自定义-map-filter-reduce-foreach"><a href="#1-2-自定义-map-filter-reduce-foreach" class="headerlink" title="1.2. 自定义 map filter reduce foreach"></a>1.2. 自定义 map filter reduce foreach</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自定义 map filter reduce foreach</span></span><br><span class="line">   <span class="keyword">val</span> array = <span class="type">Array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">custom_map</span></span>(array: <span class="type">Array</span>[<span class="type">Int</span>], op: <span class="type">Int</span> =&gt; <span class="type">Int</span>) = &#123;</span><br><span class="line">     <span class="keyword">for</span> (ele &lt;- array) <span class="keyword">yield</span> op(ele)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   custom_map(array, _ * <span class="number">2</span>).foreach(println)</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">custom_filter</span></span>(array: <span class="type">Array</span>[<span class="type">Int</span>], op: <span class="type">Int</span> =&gt; <span class="type">Boolean</span>) = &#123;</span><br><span class="line">     <span class="keyword">for</span> (ele &lt;- array <span class="keyword">if</span> op(ele)) <span class="keyword">yield</span> ele</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   custom_filter(array, x =&gt; x % <span class="number">2</span> == <span class="number">0</span>).foreach(println)</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">custom_foreach</span></span>(array: <span class="type">Array</span>[<span class="type">Int</span>], op: <span class="type">Int</span> =&gt; <span class="type">Unit</span>) = &#123;</span><br><span class="line">     <span class="keyword">for</span> (ele &lt;- array) <span class="keyword">yield</span> op(ele)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   custom_foreach(array, println(_))</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">custom_reduce</span></span>(array: <span class="type">Array</span>[<span class="type">Int</span>], op: (<span class="type">Int</span>, <span class="type">Int</span>) =&gt; <span class="type">Int</span>) = &#123;</span><br><span class="line">     <span class="keyword">var</span> last = array(<span class="number">0</span>)</span><br><span class="line">     <span class="keyword">for</span> (i &lt;- <span class="number">1</span> until (array.length)) &#123;</span><br><span class="line">       last = op(last, array(i))</span><br><span class="line">     &#125;</span><br><span class="line">     last</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   println(custom_reduce(array, _ + _))</span><br><span class="line">   println(<span class="string">&quot;----------------------------------&quot;</span>)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// map</span></span><br><span class="line">   <span class="keyword">val</span> array1 = <span class="type">List</span>(<span class="type">Array</span>((<span class="string">&quot;zhangsan&quot;</span>, <span class="number">30</span>)), <span class="type">Array</span>((<span class="string">&quot;lisi&quot;</span>, <span class="number">18</span>)))</span><br><span class="line">   array1.map(x =&gt; x.map(y =&gt; (y._1, y._2 + <span class="number">2</span>)))</span><br><span class="line"></span><br><span class="line">   <span class="comment">// foreach</span></span><br><span class="line">   array.foreach(println(_))</span><br><span class="line">   <span class="comment">// filter</span></span><br><span class="line">   array.filter(_ &gt; <span class="number">3</span>).foreach(println)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// flatten.map 和 flatmap 同等</span></span><br><span class="line">   <span class="keyword">val</span> words = <span class="type">List</span>(<span class="string">&quot;zhangsan zhangsan&quot;</span>, <span class="string">&quot;lisi lisi&quot;</span>, <span class="string">&quot;wangwu wangwu&quot;</span>)</span><br><span class="line">   words.map(x =&gt; x.split(<span class="string">&quot; &quot;</span>)).flatten.foreach(println)</span><br><span class="line">   words.flatMap(x =&gt; x.split(<span class="string">&quot; &quot;</span>)).foreach(println)</span><br><span class="line"></span><br><span class="line">   <span class="comment">// reduce</span></span><br><span class="line">   println(array.reduce(_ - _))</span><br><span class="line">   println(array.reduceLeft(_ - _))</span><br><span class="line">   println(array.reduceRight(_ - _))</span><br><span class="line">   <span class="comment">// 带初始值 fold</span></span><br><span class="line">   println(array.fold(<span class="number">0</span>)(_ - _))</span><br><span class="line">   println(array.foldRight(<span class="number">0</span>)(_ - _))</span><br><span class="line"></span><br></pre></td></tr></table></figure>







      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/07/05/scala%E5%9F%BA%E7%A1%8002/" data-id="ckw5znxwb000aw9gha4ssesl0" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-scala基础" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2019/06/24/scala%E5%9F%BA%E7%A1%80/">scala基础01</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2019/06/24/scala%E5%9F%BA%E7%A1%80/" class="article-date">
  <time datetime="2019-06-24T01:25:00.000Z" itemprop="datePublished">2019-06-24</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
      <h3 id="1"><a href="#1" class="headerlink" title="1"></a>1</h3><h4 id="1-1-生成代码文档"><a href="#1-1-生成代码文档" class="headerlink" title="1.1.生成代码文档"></a>1.1.生成代码文档</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scaladoc HelloApp.scala</span><br></pre></td></tr></table></figure>
<h4 id="1-2-val-var"><a href="#1-2-val-var" class="headerlink" title="1.2. val var"></a>1.2. val var</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> 值</span><br><span class="line"><span class="keyword">var</span> 变量</span><br><span class="line"><span class="keyword">val</span>/<span class="keyword">var</span> 名称[:类型] = </span><br></pre></td></tr></table></figure>
<h4 id="1-3-数据类型"><a href="#1-3-数据类型" class="headerlink" title="1.3.数据类型"></a>1.3.数据类型</h4><p><img src="/img/image5566556.png" alt="upload successful"></p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否是某类型</span></span><br><span class="line">println(<span class="number">10.</span>isInstanceOf[<span class="type">Int</span>])</span><br><span class="line"> <span class="comment">// 类型转换</span></span><br><span class="line"><span class="number">10.</span>asInstanceOf[<span class="type">Double</span>]</span><br><span class="line"> </span><br><span class="line"><span class="keyword">val</span> money = <span class="number">23456</span></span><br><span class="line">printf(<span class="string">&quot;格式化输出:%d\n&quot;</span>, money)</span><br><span class="line">printf(<span class="string">&quot;格式化输出浮点数:%f\n&quot;</span>, math.<span class="type">Pi</span>)</span><br><span class="line">printf(<span class="string">&quot;格式化输出浮点数保留三位:%f\n&quot;</span>, math.<span class="type">Pi</span>)</span><br></pre></td></tr></table></figure>
<h4 id="1-4-常用写法-字符串插值-多行输出"><a href="#1-4-常用写法-字符串插值-多行输出" class="headerlink" title="1.4.常用写法 字符串插值 多行输出"></a>1.4.常用写法 字符串插值 多行输出</h4> <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字符串插值</span></span><br><span class="line">  <span class="keyword">val</span> name = <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">  <span class="keyword">val</span> age = <span class="number">26</span></span><br><span class="line">  println(<span class="string">s&quot;<span class="subst">$name</span>==&gt;<span class="subst">$&#123;age - 2&#125;</span>&quot;</span>)</span><br><span class="line">  </span><br><span class="line">    <span class="comment">// 多行输出</span></span><br><span class="line">    <span class="keyword">val</span> weCome =</span><br><span class="line">            <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">              |2222</span></span><br><span class="line"><span class="string">              |111</span></span><br><span class="line"><span class="string">              |33</span></span><br><span class="line"><span class="string">              |&quot;&quot;&quot;</span>.stripMargin</span><br><span class="line">        println(weCome)</span><br></pre></td></tr></table></figure>
<h4 id="1-5-条件判断"><a href="#1-5-条件判断" class="headerlink" title="1.5.条件判断"></a>1.5.条件判断</h4>   <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断</span></span><br><span class="line"><span class="keyword">var</span> a = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> (a % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">val</span> a = <span class="keyword">if</span>(x&gt;y) x <span class="keyword">else</span> y</span><br></pre></td></tr></table></figure>
<h4 id="1-5-循环"><a href="#1-5-循环" class="headerlink" title="1.5.循环"></a>1.5.循环</h4><pre><code> <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (a &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">     println(a)</span><br><span class="line">     a += <span class="number">1</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">val</span> s = <span class="string">&quot;asdfgh&quot;</span></span><br><span class="line"><span class="comment">// 增强for循环</span></span><br><span class="line"> <span class="keyword">for</span> (ele &lt;- s) &#123;</span><br><span class="line">     println(ele)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to <span class="number">3</span>) &#123;</span><br><span class="line">     println(i)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 和上面等价</span></span><br><span class="line"> <span class="keyword">for</span> (i &lt;- <span class="number">1.</span>to(<span class="number">3</span>)) &#123;</span><br><span class="line">     println(i)</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="comment">// 左闭右开区间[)</span></span><br><span class="line"> <span class="keyword">for</span> (i &lt;- <span class="number">1</span> until (<span class="number">3</span>)) &#123;</span><br><span class="line">     println(i)</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 10以内的奇数</span></span><br><span class="line"> <span class="keyword">for</span> (i &lt;- <span class="number">1</span> to <span class="number">10</span> <span class="keyword">if</span> i % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">     println(i)</span><br><span class="line"> &#125;</span><br><span class="line">    <span class="comment">// 九九乘方</span></span><br><span class="line">     <span class="keyword">for</span> (i&lt;<span class="number">-1</span> to <span class="number">9</span>;j&lt;<span class="number">-1</span> to i) &#123;</span><br><span class="line">     print(<span class="string">s&quot;<span class="subst">$i</span> * <span class="subst">$j</span> = <span class="subst">$&#123;i * j&#125;</span>\t&quot;</span>)</span><br><span class="line">     <span class="keyword">if</span> (i ==j) println()</span><br><span class="line"> &#125;</span><br><span class="line">     <span class="comment">// 将for循环里面的每个数承2</span></span><br><span class="line"> <span class="keyword">for</span> (i&lt;<span class="number">-1</span> to <span class="number">9</span>) <span class="keyword">yield</span> i * <span class="number">2</span></span><br><span class="line"> <span class="keyword">for</span> (i&lt;<span class="number">-1</span> to <span class="number">9</span>) <span class="keyword">yield</span> i * i</span><br><span class="line"></span><br><span class="line"> println(<span class="keyword">for</span> (ele&lt;- <span class="string">&quot;abcdefg&quot;</span>) <span class="keyword">yield</span> ele.toString.toUpperCase()+ele)</span><br></pre></td></tr></table></figure>
</code></pre>
<h4 id="1-6-退出break"><a href="#1-6-退出break" class="headerlink" title="1.6.退出break"></a>1.6.退出break</h4>   <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> scala.util.control.<span class="type">Breaks</span>.&#123;<span class="keyword">break</span>, breakable&#125;</span><br><span class="line">        <span class="comment">// sacla 中的退出</span></span><br><span class="line">        breakable &#123;</span><br><span class="line">            <span class="keyword">for</span> (i &lt;- <span class="number">2</span> until (<span class="number">7</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="number">7</span> % i == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-7-方法定义-def"><a href="#1-7-方法定义-def" class="headerlink" title="1.7.方法定义 def"></a>1.7.方法定义 def</h4>   <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">max</span></span>(x:<span class="type">Int</span>,y:<span class="type">Int</span>): <span class="type">Int</span> = &#123;</span><br><span class="line">        <span class="keyword">if</span> (x&gt;y) x <span class="keyword">else</span> y</span><br><span class="line">    &#125;</span><br><span class="line">    println(max(<span class="number">1</span>,<span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 可变长参数</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sum</span></span>(nums:<span class="type">Int</span>*):<span class="type">Int</span>= &#123;</span><br><span class="line">        <span class="keyword">var</span> result = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> (num&lt;-nums) &#123;</span><br><span class="line">            result+=num</span><br><span class="line">        &#125;</span><br><span class="line">        result</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    println(sum(<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line">    <span class="comment">// 1到5相加</span></span><br><span class="line">    println(sum(<span class="number">1</span> to <span class="number">5</span>:_*))</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">printCourses</span></span>(course:<span class="type">String</span>*): <span class="type">Unit</span> = &#123;</span><br><span class="line">        println(course)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> array = <span class="type">Array</span>(<span class="string">&quot;hadoop&quot;</span>,<span class="string">&quot;scala&quot;</span>,<span class="string">&quot;Flink&quot;</span>)</span><br><span class="line">    printCourses(array:_*)</span><br></pre></td></tr></table></figure>
<h3 id="2-集合"><a href="#2-集合" class="headerlink" title="2.集合"></a>2.集合</h3>   <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala.collection</span><br><span class="line">scala.collection.immutable and scala.collection.mutable</span><br></pre></td></tr></table></figure>
<h4 id="2-1-array"><a href="#2-1-array" class="headerlink" title="2.1.array"></a>2.1.array</h4>   <figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">val</span> a = <span class="type">Array</span>（<span class="number">1</span>，<span class="number">2</span>，<span class="number">3</span>，<span class="number">4</span>）</span><br><span class="line"><span class="keyword">val</span> b = <span class="type">Array</span>（<span class="number">5</span>，<span class="number">6</span>）</span><br><span class="line"><span class="comment">// 两个array相加并打印输出</span></span><br><span class="line">(a+b).foreach(println)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 对array进行迭代</span></span><br><span class="line"><span class="keyword">for</span>（ele &lt;- c）&#123;</span><br><span class="line"> println(ele)</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">for</span>（ele &lt;- c.reverse）&#123;</span><br><span class="line"> println(ele)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 可变数组</span></span><br><span class="line"><span class="type">ArrayBuffer</span></span><br><span class="line"><span class="comment">// 增加 insert</span></span><br><span class="line"><span class="comment">// 删除 remove</span></span><br><span class="line"><span class="comment">// 从尾部删除 trimEnd(2)</span></span><br><span class="line">max min sum</span><br></pre></td></tr></table></figure>
<h4 id="2-2-set"><a href="#2-2-set" class="headerlink" title="2.2.set"></a>2.2.set</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Set</span>() 无序 去重</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-3-Tuple"><a href="#2-3-Tuple" class="headerlink" title="2.3.Tuple"></a>2.3.Tuple</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">（.....）</span><br><span class="line"><span class="comment">// 最多放22个元素</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> a = (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">    <span class="comment">// 遍历</span></span><br><span class="line">    <span class="keyword">for</span> (i &lt;- <span class="number">0</span> until (a.productArity)) &#123;</span><br><span class="line">      println(a.productElement(i))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (ele &lt;- a.productIterator) &#123;</span><br><span class="line">      println(ele)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 对偶元组</span></span><br><span class="line">    <span class="keyword">val</span> t1 = (<span class="string">&quot;张三&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>)</span><br><span class="line">    <span class="comment">// 两者交换位置</span></span><br><span class="line">    println(t1.swap)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 常用灵活写法 (输出结果为tuple)</span></span><br><span class="line">    <span class="keyword">val</span> array: <span class="type">Array</span>[<span class="type">Int</span>] = <span class="type">Array</span>[<span class="type">Int</span>](<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method</span></span>(array: <span class="type">Array</span>[<span class="type">Int</span>]) = &#123;</span><br><span class="line">      (array.max, array.min, array.sum / array.length)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> tuple = method(array)</span><br><span class="line">    println(tuple._1)</span><br><span class="line">    println(tuple._2)</span><br><span class="line">    println(tuple._3)</span><br><span class="line">    <span class="keyword">val</span> (max, min, avg) = method(array)</span><br><span class="line">    println(max)</span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-4-Map"><a href="#2-4-Map" class="headerlink" title="2.4.Map"></a>2.4.Map</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">val</span> map1 = <span class="type">Map</span>(<span class="string">&quot;zhangsan&quot;</span> -&gt; <span class="number">19</span>, <span class="string">&quot;lisi&quot;</span> -&gt; <span class="number">23</span>)</span><br><span class="line"><span class="comment">// 遍历</span></span><br><span class="line"><span class="keyword">for</span>((k,v)&lt;-map1) &#123;</span><br><span class="line">  println((k, v))</span><br><span class="line">&#125;</span><br><span class="line">map1.foreach(println)</span><br><span class="line"><span class="comment">// 获取所有key</span></span><br><span class="line"><span class="keyword">for</span> (ele &lt;-map1.keys) &#123;</span><br><span class="line">  println(ele)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 获取所有value</span></span><br><span class="line"><span class="keyword">for</span> (ele &lt;-map1.values) &#123;</span><br><span class="line">  println(ele)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据key取value</span></span><br><span class="line">println(map1.getOrElse(<span class="string">&quot;lisi&quot;</span>, <span class="number">0</span>))</span><br></pre></td></tr></table></figure>

<h4 id="2-5-Queue"><a href="#2-5-Queue" class="headerlink" title="2.5.Queue"></a>2.5.Queue</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">val q1: mutable.Queue[Int] &#x3D; new mutable.Queue[Int]()</span><br><span class="line">q1 +&#x3D; (20,39)</span><br><span class="line">println(q1)</span><br><span class="line">println(q1.dequeue())</span><br><span class="line">println(q1.head)</span><br><span class="line">q1.tail</span><br><span class="line">q1.last</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-6-List"><a href="#2-6-List" class="headerlink" title="2.6.List"></a>2.6.List</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">List</span></span><br><span class="line"></span><br><span class="line"><span class="type">Nil</span> 是空<span class="type">List</span>集合</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="2-7-常用集合"><a href="#2-7-常用集合" class="headerlink" title="2.7.常用集合"></a>2.7.常用集合</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">ArraBuffer</span></span><br><span class="line"><span class="type">Map</span>/<span class="type">HashMap</span></span><br><span class="line"><span class="type">List</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>







      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/06/24/scala%E5%9F%BA%E7%A1%80/" data-id="ckw5znxwd000ew9gh4gd10mxi" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-MapReduce" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2019/05/08/MapReduce/">MapReduce</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2019/05/08/MapReduce/" class="article-date">
  <time datetime="2019-05-08T13:59:00.000Z" itemprop="datePublished">2019-05-08</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
      <h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1.简介"></a>1.简介</h2><p>map:映射<br>将一组数据按照规则 映射为一组<br>数据条数不会发生变化</p>
<p>例如：<br>select age+1 from table1;</p>
<p>reduce:规约 汇总 数据条数会发生变化</p>
<p>例如：<br>group by</p>
<p>shuffle 洗牌 数据根据key进行网络传输 规整到一起，按规则计算</p>
<p>shuffle 因为会网络传输，会拉长计算的时间，能不shuffle就不shuffle</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-架构"><a href="#2-架构" class="headerlink" title="2.架构"></a>2.架构</h2><p>计算：cpu+内存</p>
<p>ResourceManager(rm) 主<br>ApplicationsManager 应用管理器 作业 程序<br>ResourceScheduler     资源管理器 </p>
<p>NodeManager(nm) 从</p>
<p>container</p>
<hr>
<p>Linux两个机制：<br>1.oom-killer机制</p>
<p>当Linux服务器某个进程使用内存超标 Linux机器为了保护自己，主动杀死进程释放内存</p>
<p>2./tmp 目录<br>30天自动删除机制</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2019/05/08/MapReduce/" data-id="ckw5znxwa0007w9gh2m2941uo" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-flask-Python-编写的轻量级-Web-应用框架" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2018/11/19/flask-Python-%E7%BC%96%E5%86%99%E7%9A%84%E8%BD%BB%E9%87%8F%E7%BA%A7-Web-%E5%BA%94%E7%94%A8%E6%A1%86%E6%9E%B6/">flask-python 编写的轻量级 Web 应用框架</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2018/11/19/flask-Python-%E7%BC%96%E5%86%99%E7%9A%84%E8%BD%BB%E9%87%8F%E7%BA%A7-Web-%E5%BA%94%E7%94%A8%E6%A1%86%E6%9E%B6/" class="article-date">
  <time datetime="2018-11-19T01:36:00.000Z" itemprop="datePublished">2018-11-19</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
      <h1 id="flask-demo"><a href="#flask-demo" class="headerlink" title="flask-demo"></a>flask-demo</h1><p>flask: Python 编写的轻量级 Web 应用框架</p>
<h2 id="1-flask环境准备"><a href="#1-flask环境准备" class="headerlink" title="1.flask环境准备"></a>1.flask环境准备</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim requirements.txt</span><br><span class="line">flask</span><br><span class="line">flask_sqlalchemy</span><br><span class="line">mysqlclient</span><br><span class="line">redis</span><br><span class="line"></span><br><span class="line">安装pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>flask学习文档参考:<a target="_blank" rel="noopener" href="http://docs.jinkan.org/docs/flask/">http://docs.jinkan.org/docs/flask/</a></p>
<h2 id="2-flask第一行代码"><a href="#2-flask第一行代码" class="headerlink" title="2.flask第一行代码"></a>2.flask第一行代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1.初始化：所有的Flask都必须创建程序实例</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">第二部分，路由和视图函数：</span></span><br><span class="line"><span class="string">    客户端发送url给web服务器，web服务器将url转发给flask程序实例，程序实例</span></span><br><span class="line"><span class="string">    需要知道对于每一个url请求启动那一部分代码，所以保存了一个url和python函数的映射关系。</span></span><br><span class="line"><span class="string">    处理url和函数之间关系的程序，称为路由</span></span><br><span class="line"><span class="string">    在flask中，定义路由最简便的方式，是使用程序实例的app.route装饰器，把装饰的函数注册为路由</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/hello&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">第三部分：程序实例用run方法启动flask集成的开发web服务器</span></span><br><span class="line"><span class="string">    __name__ == &#x27;__main__&#x27;是python常用的方法，表示只有直接启动本脚本时候，才用app.run方法</span></span><br><span class="line"><span class="string">    服务器启动后，会启动轮询，等待并处理请求。轮询会一直请求，直到程序停止。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, debug=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">flask接收web请求的执行流程</span></span><br><span class="line"><span class="string">    1.浏览器将请求给web服务器，web服务器将请求给app ,</span></span><br><span class="line"><span class="string">    2.app收到请求，通过路由找到对应的视图函数，然后将请求处理，得到一个响应response</span></span><br><span class="line"><span class="string">    3.然后app将响应返回给web服务器，</span></span><br><span class="line"><span class="string">    4.web服务器返回给浏览器，</span></span><br><span class="line"><span class="string">    5.浏览器展示给用户观看，流程完毕。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>



<h2 id="3-结构分层模板"><a href="#3-结构分层模板" class="headerlink" title="3.结构分层模板"></a>3.结构分层模板</h2><h2 id="4-DEBUG调试"><a href="#4-DEBUG调试" class="headerlink" title="4.DEBUG调试"></a>4.DEBUG调试</h2><p>Pycharm断点调试</p>
<h2 id="5-flask连接数据库"><a href="#5-flask连接数据库" class="headerlink" title="5.flask连接数据库"></a>5.flask连接数据库</h2><p>官方文档参考:<a target="_blank" rel="noopener" href="http://www.pythondoc.com/flask-sqlalchemy/quickstart.html">http://www.pythondoc.com/flask-sqlalchemy/quickstart.html</a></p>
<h3 id="5-1-数据库连接配置"><a href="#5-1-数据库连接配置" class="headerlink" title="5.1.数据库连接配置"></a>5.1.数据库连接配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SQLALCHEMY_DATABASE_URI = &quot;mysql://root:123456@127.0.0.1/demo_test&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 设置每次请求结束后会自动提交数据库的改动</span></span><br><span class="line">SQLALCHEMY_TRACK_MODIFICATIONS = True</span><br><span class="line">SQLALCHEMY_COMMIT_ON_TEARDOWN = True</span><br></pre></td></tr></table></figure>



<h3 id="5-2-根据数据库逆向生成model"><a href="#5-2-根据数据库逆向生成model" class="headerlink" title="5.2.根据数据库逆向生成model"></a>5.2.根据数据库逆向生成model</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">将数据库中的所有表放在同一个实体中</span><br><span class="line">flask-sqlacodegen &#x27;mysql://root:123456@127.0.0.1/demo_test&#x27;  --outfile &quot;model/demo_test.py&quot;  --flask</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">将每一个表单独放在同一个实体中</span><br><span class="line">flask-sqlacodegen &#x27;mysql://root:123456@127.0.0.1/demo_test&#x27; --tables employees --outfile &quot;common/models/employees.py&quot;  --flask</span><br></pre></td></tr></table></figure>

<h2 id="6-GET-POST请求"><a href="#6-GET-POST请求" class="headerlink" title="6.GET/POST请求"></a>6.GET/POST请求</h2><h3 id="6-1-get请求查询数据库返回json格式"><a href="#6-1-get请求查询数据库返回json格式" class="headerlink" title="6.1.get请求查询数据库返回json格式"></a>6.1.get请求查询数据库返回json格式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/get/employee/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_employee</span>():</span></span><br><span class="line">    employee_id = request.args.get(<span class="string">&quot;employeeId&quot;</span>)</span><br><span class="line">    logging.debug(<span class="string">&quot;employee_id = &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(employee_id))</span><br><span class="line">    <span class="keyword">if</span> employee_id.strip() ==<span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    result = Employee.query.<span class="built_in">filter</span>(Employee.<span class="built_in">id</span> == employee_id).<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">for</span> employee <span class="keyword">in</span> result:</span><br><span class="line">        data = &#123;<span class="string">&quot;id&quot;</span>: employee.<span class="built_in">id</span>, <span class="string">&quot;lastname&quot;</span>: employee.lastname, <span class="string">&quot;email&quot;</span>: employee.email,</span><br><span class="line">                <span class="string">&quot;salary&quot;</span>: employee.salary, <span class="string">&quot;dept&quot;</span>: employee.dept&#125;</span><br><span class="line">        response = make_response(json.dumps(data, cls=DecimalEncoder, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<h3 id="6-2-post请求查询数据库返回json格式"><a href="#6-2-post请求查询数据库返回json格式" class="headerlink" title="6.2.post请求查询数据库返回json格式"></a>6.2.post请求查询数据库返回json格式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/post/employee/&quot;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post_employee</span>():</span></span><br><span class="line">    employee_id = request.form.get(<span class="string">&quot;employeeId&quot;</span>)</span><br><span class="line">    logging.debug(<span class="string">&quot;employee_id = &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(employee_id))</span><br><span class="line">    <span class="keyword">if</span> employee_id.strip() ==<span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    result = Employee.query.<span class="built_in">filter</span>(Employee.<span class="built_in">id</span> == employee_id).<span class="built_in">all</span>()</span><br><span class="line">    <span class="keyword">for</span> employee <span class="keyword">in</span> result:</span><br><span class="line">        data = &#123;<span class="string">&quot;id&quot;</span>: employee.<span class="built_in">id</span>, <span class="string">&quot;lastname&quot;</span>: employee.lastname, <span class="string">&quot;email&quot;</span>: employee.email,</span><br><span class="line">                <span class="string">&quot;salary&quot;</span>: employee.salary, <span class="string">&quot;dept&quot;</span>: employee.dept&#125;</span><br><span class="line">        response = make_response(json.dumps(data, cls=DecimalEncoder, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>



<h2 id="7-读写redis"><a href="#7-读写redis" class="headerlink" title="7.读写redis"></a>7.读写redis</h2><h3 id="7-1-读写redis代码实现"><a href="#7-1-读写redis代码实现" class="headerlink" title="7.1.读写redis代码实现"></a>7.1.读写redis代码实现</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="comment">#  @staticmethod, 表示静态方法</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Redis</span>:</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">host=<span class="string">&#x27;localhost&#x27;</span>, port=<span class="number">6379</span>, db=<span class="number">0</span></span>):</span></span><br><span class="line">        r = redis.StrictRedis(host, port, db)</span><br><span class="line">        <span class="keyword">return</span> r</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将内存数据二进制通过序列号转为文本流，再存入redis</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">set_data</span>(<span class="params">r, key, data, ex=<span class="literal">None</span></span>):</span></span><br><span class="line">        r.<span class="built_in">set</span>(pickle.dumps(key), pickle.dumps(data), ex)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将文本流从redis中读取并反序列化，返回</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_data</span>(<span class="params">r, key</span>):</span></span><br><span class="line">        data = r.get(pickle.dumps(key))</span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> pickle.loads(data)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="8-日志配置"><a href="#8-日志配置" class="headerlink" title="8.日志配置"></a>8.日志配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&quot;&quot;&quot;</span><br><span class="line">     # 日志格式</span><br><span class="line">     [时间戳] \t [线程名] \t [日志级别] \t msg</span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line">import logging</span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.DEBUG,# 控制台打印的日志级别</span><br><span class="line">                    filename=&#x27;D:/003code/flask-demo/logs/log_new.log&#x27;,  # 将日志写入log_new.log文件中</span><br><span class="line">                    filemode=&#x27;a&#x27;, # 模式，有w和a，w就是写模式，每次都会重新写日志，覆盖之前的日志</span><br><span class="line">                    # a是追加模式，默认如果不写的话，就是追加模式</span><br><span class="line">                    format=</span><br><span class="line">                    &#x27;[%(asctime)s]    [%(threadName)s]    [%(levelname)s]   %(message)s&#x27;, datefmt=&#x27;%Y-%m-%d %H:%M:%S&#x27;</span><br><span class="line">                    )</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置完成后,需要将配置引入manager</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> config.log_conf</span><br></pre></td></tr></table></figure>



<h2 id="9-单元测试"><a href="#9-单元测试" class="headerlink" title="9.单元测试"></a>9.单元测试</h2><p>Python Flask，单元测试案例，unittest<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/houyanhua1/article/details/85689951">https://blog.csdn.net/houyanhua1/article/details/85689951</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/feilzhang/article/details/81041819">https://blog.csdn.net/feilzhang/article/details/81041819</a></p>
<ul>
<li>单元测试代码</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> unittest</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> manager <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHello</span>(<span class="params">unittest.TestCase</span>):</span></span><br><span class="line">    <span class="comment"># 测试代码执行之前调用 (方法名固定)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.app = app</span><br><span class="line">        app.config[<span class="string">&#x27;TESTING&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        self.client = self.app.test_client()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_hello</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 请求接口</span></span><br><span class="line">        response = self.client.get(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">        json_data = response.data</span><br><span class="line">        <span class="comment"># 按照json解析</span></span><br><span class="line">        json_dict = json.loads(json_data)</span><br><span class="line">        code = json_dict.get(<span class="string">&quot;code&quot;</span>)</span><br><span class="line">        <span class="comment"># 使用断言进行验证(判断字符串是否含有code)</span></span><br><span class="line">        self.assertIn(<span class="string">&quot;code&quot;</span>, json_dict)</span><br><span class="line">        <span class="comment"># 使用断言判断code是否为200</span></span><br><span class="line">        self.assertEqual(code, <span class="string">&quot;200&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestGetEmployee</span>(<span class="params">unittest.TestCase</span>):</span></span><br><span class="line">    <span class="comment"># 测试代码执行之前调用 (方法名固定)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setUp</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 配置数据库</span></span><br><span class="line">        app.config[<span class="string">&#x27;TESTING&#x27;</span>] = <span class="literal">True</span></span><br><span class="line">        app.config[<span class="string">&#x27;SQLALCHEMY_DATABASE_URI&#x27;</span>] = <span class="string">&#x27;mysql://root:123456@127.0.0.1/demo_test&#x27;</span></span><br><span class="line">        app.config[<span class="string">&quot;SQLALCHEMY_TRACK_MODIFICATIONS&quot;</span>] = <span class="literal">True</span></span><br><span class="line">        app.config[<span class="string">&quot;SQLALCHEMY_COMMIT_ON_TEARDOWN&quot;</span>] = <span class="literal">True</span></span><br><span class="line">        self.app = app</span><br><span class="line">        self.client = self.app.test_client()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_post_employee</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 请求接口</span></span><br><span class="line">        response = self.client.post(<span class="string">&#x27;/post/employee/&#x27;</span>, data=&#123;<span class="string">&quot;employeeId&quot;</span>: <span class="number">2</span>&#125;)</span><br><span class="line">        json_data = response.data</span><br><span class="line">        <span class="comment"># 按照json解析</span></span><br><span class="line">        json_dict = json.loads(json_data)</span><br><span class="line">        <span class="comment"># 使用断言进行验证(判断字符串是否含有lastname)</span></span><br><span class="line">        self.assertIn(<span class="string">&quot;lastname&quot;</span>, json_dict)</span><br><span class="line">        <span class="comment"># 使用断言判断lastname是否为李四</span></span><br><span class="line">        last_name = json_dict.get(<span class="string">&quot;lastname&quot;</span>)</span><br><span class="line">        self.assertEqual(last_name, <span class="string">&quot;李四&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test_get_employee</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 请求接口</span></span><br><span class="line">        response = self.client.get(<span class="string">&#x27;/get/employee/?employeeId=2&#x27;</span>)</span><br><span class="line">        json_data = response.data</span><br><span class="line">        <span class="comment"># 按照json解析</span></span><br><span class="line">        json_dict = json.loads(json_data)</span><br><span class="line">        <span class="comment"># 使用断言进行验证(判断字符串是否含有lastname)</span></span><br><span class="line">        self.assertIn(<span class="string">&quot;lastname&quot;</span>, json_dict)</span><br><span class="line">        <span class="comment"># 使用断言判断lastname是否为李四</span></span><br><span class="line">        last_name = json_dict.get(<span class="string">&quot;lastname&quot;</span>)</span><br><span class="line">        self.assertEqual(last_name, <span class="string">&quot;李四&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    unittest.main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="10-蓝图"><a href="#10-蓝图" class="headerlink" title="10 蓝图"></a>10 蓝图</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">注册路由 - 蓝图</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">待整理.....</span><br><span class="line"></span><br></pre></td></tr></table></figure>





      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/11/19/flask-Python-%E7%BC%96%E5%86%99%E7%9A%84%E8%BD%BB%E9%87%8F%E7%BA%A7-Web-%E5%BA%94%E7%94%A8%E6%A1%86%E6%9E%B6/" data-id="ckw5znxwb0008w9gh2of6dl6v" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
    <article id="post-数据库服务器环境配置-ubuntu" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h2 itemprop="name">
  <a class="article-title" href="/2018/11/01/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE-ubuntu/">数据库服务器环境配置-ubuntu</a>
</h2>



    </header>
    

    
    <div class="article-meta">
      <a href="/2018/11/01/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE-ubuntu/" class="article-date">
  <time datetime="2018-11-01T02:41:00.000Z" itemprop="datePublished">2018-11-01</time>
</a>
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      
      
        
      
      
      <h3 id="1-ubuntu配置yum源"><a href="#1-ubuntu配置yum源" class="headerlink" title="1.ubuntu配置yum源"></a>1.ubuntu配置yum源</h3><h4 id="1-1-安装yum"><a href="#1-1-安装yum" class="headerlink" title="1.1. 安装yum"></a>1.1. <strong>安装yum</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install yum</span><br></pre></td></tr></table></figure>

<h4 id="1-2-配置yum源"><a href="#1-2-配置yum源" class="headerlink" title="1.2. 配置yum源"></a>1.2. <strong>配置yum源</strong></h4><p>在/etc/yum/repos.d/目录下创建两个文件，fedora-163.repo和fedora-updates-163.repo</p>
<p> 推荐使用vim编辑器。在终端使用： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">vim fedora-163.repo</span><br><span class="line"></span><br><span class="line">内容如下:</span><br><span class="line"></span><br><span class="line">[fedora]</span><br><span class="line">name=Fedora 17 - $basearch - 163.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.163.com/fedora/releases/17/Everything/$basearch/os/</span><br><span class="line">mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=fedora-17&amp;arch=$basearch</span><br><span class="line">enabled=1</span><br><span class="line">metadata_expire=7d</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$basearch</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[fedora-debuginfo]</span><br><span class="line">name=Fedora 17 - $basearch - Debug - 163.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.163.com/fedora/releases/17/Everything/$basearch/debug/</span><br><span class="line">mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=fedora-debug-17&amp;arch=$basearch</span><br><span class="line">enabled=0</span><br><span class="line">metadata_expire=7d</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$basearch</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[fedora-source]</span><br><span class="line">name=Fedora 17 - Source - 163.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.163.com/fedora/releases/17/Everything/source/SRPMS/</span><br><span class="line">mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=fedora-source-17&amp;arch=$basearch</span><br><span class="line">enabled=0</span><br><span class="line">metadata_expire=7d</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$basearch</span><br></pre></td></tr></table></figure>

<p>vim  fedora-updates-163.repo </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[updates]</span><br><span class="line">name=Fedora 17 - $basearch - Updates - 163.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.163.com/fedora/updates/17/$basearch/</span><br><span class="line">mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=updates-released-f17&amp;arch=$basearch</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$basearch</span><br><span class="line"> </span><br><span class="line">[updates-debuginfo]</span><br><span class="line">name=Fedora 17 - $basearch - Updates - Debug - 163.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.163.com/fedora/updates/17/$basearch/debug/</span><br><span class="line">mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=updates-released-debug-f17&amp;arch=$basearch</span><br><span class="line">enabled=0</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$basearch</span><br><span class="line"> </span><br><span class="line">[updates-source]</span><br><span class="line">name=Fedora 17 - Updates Source - 163.com</span><br><span class="line">failovermethod=priority</span><br><span class="line">baseurl=http://mirrors.163.com/fedora/updates/17/SRPMS/</span><br><span class="line">mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=updates-released-source-f17&amp;arch=$basearch</span><br><span class="line">enabled=0</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-fedora-$basearch</span><br></pre></td></tr></table></figure>



<h4 id="1-3-执行配置"><a href="#1-3-执行配置" class="headerlink" title="1.3. 执行配置"></a>1.3. <strong>执行配置</strong></h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum makecache</span><br></pre></td></tr></table></figure>



<p>如果行 yum makecache ,不成功先执行下列命令升级依赖</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br></pre></td></tr></table></figure>

<p>参考:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_42712552&#x2F;article&#x2F;details&#x2F;88363272</span><br></pre></td></tr></table></figure>



<h3 id="2-ubuntu16-0-4安装jdk"><a href="#2-ubuntu16-0-4安装jdk" class="headerlink" title="2.ubuntu16.0.4安装jdk"></a>2.ubuntu16.0.4安装jdk</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">加压缩安装包后,配置环境变量</span><br><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;profile</span><br><span class="line"></span><br><span class="line">#JAVA_HOME</span><br><span class="line">export JAVA_HOME&#x3D;&#x2F;opt&#x2F;module&#x2F;1.8.0_181</span><br><span class="line">export PATH&#x3D;$PATH:$JAVA_HOME&#x2F;bin</span><br><span class="line"></span><br><span class="line">让修改后的文件生效</span><br><span class="line">source &#x2F;etc&#x2F;profile</span><br><span class="line"></span><br><span class="line">测试JDK是否安装成功</span><br><span class="line">java -version</span><br></pre></td></tr></table></figure>

<h3 id="3-ubuntu16-0-4安装redis"><a href="#3-ubuntu16-0-4安装redis" class="headerlink" title="3.ubuntu16.0.4安装redis"></a>3.ubuntu16.0.4安装redis</h3><h4 id="3-1-安装redis环境依赖"><a href="#3-1-安装redis环境依赖" class="headerlink" title="3.1.安装redis环境依赖"></a>3.1.安装redis环境依赖</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#安装C程序运行环境</span><br><span class="line">yum -y install gcc-c++</span><br><span class="line"></span><br><span class="line"># 安装tcl</span><br><span class="line"></span><br><span class="line">wget http:&#x2F;&#x2F;downloads.sourceforge.net&#x2F;tcl&#x2F;tcl8.6.1-src.tar.gz  </span><br><span class="line">sudo tar xzvf tcl8.6.1-src.tar.gz  -C &#x2F;usr&#x2F;local&#x2F;  </span><br><span class="line">cd  &#x2F;usr&#x2F;local&#x2F;tcl8.6.1&#x2F;unix&#x2F;  </span><br><span class="line">sudo .&#x2F;configure  </span><br><span class="line">sudo make  </span><br><span class="line">sudo make install   </span><br><span class="line">————————————————</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="3-2-下载-编译和安装redis"><a href="#3-2-下载-编译和安装redis" class="headerlink" title="3.2.下载/编译和安装redis"></a>3.2.下载/编译和安装redis</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#下载redis</span><br><span class="line">wget http:&#x2F;&#x2F;download.redis.io&#x2F;releases&#x2F;redis-3.0.5.tar.gz</span><br><span class="line"></span><br><span class="line">#解压</span><br><span class="line"></span><br><span class="line">#进入到redis安装目录</span><br><span class="line">make MALLOC&#x3D;libc</span><br><span class="line">make</span><br><span class="line">make test &amp;&amp; make install</span><br></pre></td></tr></table></figure>



<h4 id="3-3-配置redis-conf"><a href="#3-3-配置redis-conf" class="headerlink" title="3.3.配置redis.conf"></a>3.3.配置redis.conf</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#在redis安装目录</span><br><span class="line">mkdir logs</span><br><span class="line">mkdir redisdata</span><br><span class="line"></span><br><span class="line">vim redis.conf</span><br><span class="line"></span><br><span class="line">#配置后台启动</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile &#x2F;var&#x2F;run&#x2F;redis_6379.pid</span><br><span class="line">logfile &quot;&#x2F;opt&#x2F;module&#x2F;redis-3.0.5&#x2F;logs&#x2F;redis.log&quot;</span><br><span class="line">dir &#x2F;opt&#x2F;module&#x2F;redis-3.0.5&#x2F;redisdata</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">更改redis密码:</span><br><span class="line">config set requirepass Ikingtec909</span><br><span class="line">刷新验证密码</span><br><span class="line">auth Ikingtec909</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-4-启动与连接redis"><a href="#3-4-启动与连接redis" class="headerlink" title="3.4.启动与连接redis"></a>3.4.启动与连接redis</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#启动redis,进入到redis的src下</span><br><span class="line">.&#x2F;redis-server  ..&#x2F;redis.conf</span><br><span class="line"></span><br><span class="line">#连接redis,进入到redis的src下</span><br><span class="line">.&#x2F;redis-cli</span><br><span class="line"></span><br><span class="line">.&#x2F;redis-cli -p 6379 -a Ikingtec909</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="3-5-配置主从架构"><a href="#3-5-配置主从架构" class="headerlink" title="3.5.配置主从架构"></a>3.5.配置主从架构</h4><p>从服务器redis安装和上面相同</p>
<p>在redis.conf,多添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slaveof 主服务器ip 6379</span><br><span class="line">masterauth  Ikingtec909(密码)</span><br></pre></td></tr></table></figure>



<h3 id="4-ubuntu16-0-4安装mysql"><a href="#4-ubuntu16-0-4安装mysql" class="headerlink" title="4.ubuntu16.0.4安装mysql"></a>4.ubuntu16.0.4安装mysql</h3><h4 id="4-1-安装包下载地址"><a href="#4-1-安装包下载地址" class="headerlink" title="4.1.安装包下载地址"></a>4.1.安装包下载地址</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">下载(安装包)</span><br><span class="line"></span><br><span class="line">wget  https:&#x2F;&#x2F;cdn.mysql.com&#x2F;&#x2F;Downloads&#x2F;MySQL-5.7&#x2F;mysql-server_5.7.27-1ubuntu16.04_amd64.deb-bundle.tar</span><br></pre></td></tr></table></figure>

<h4 id="4-2-安装"><a href="#4-2-安装" class="headerlink" title="4.2.安装"></a>4.2.安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">解压</span><br><span class="line">tar -xvf mysql-server_5.7.27-1ubuntu16.04_amd64.deb-bundle.tar</span><br><span class="line"></span><br><span class="line">安装</span><br><span class="line">sudo dpkg -i *.deb</span><br><span class="line">sudo apt-get -f install</span><br></pre></td></tr></table></figure>

<h4 id="4-3-登录"><a href="#4-3-登录" class="headerlink" title="4.3.登录"></a>4.3.登录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql  -u  用户名 –p</span><br></pre></td></tr></table></figure>

<h4 id="4-4-修改一些配置-参考"><a href="#4-4-修改一些配置-参考" class="headerlink" title="4.4.修改一些配置(参考)"></a>4.4.修改一些配置(参考)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">#启动</span><br><span class="line">service mysql start</span><br><span class="line"></span><br><span class="line">#停止</span><br><span class="line">service mysql stop</span><br><span class="line"></span><br><span class="line">#重启</span><br><span class="line">service mysql restart</span><br><span class="line"></span><br><span class="line"># 授权给特定host及用户</span><br><span class="line">登录到mysql</span><br><span class="line">use mysql;</span><br><span class="line">select host,user from user;</span><br><span class="line">update user set host &#x3D; &#39;%&#39; where user &#x3D;&#39;root&#39;;</span><br><span class="line">select host,user from user;</span><br><span class="line"></span><br><span class="line">#更改用户名和密码</span><br><span class="line"></span><br><span class="line">(适用于管理员或者有全局权限的用户重设其它用户的密码)</span><br><span class="line"></span><br><span class="line">进入命令行模式</span><br><span class="line"></span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line">mysql&gt;use mysql;</span><br><span class="line"></span><br><span class="line">mysql&gt; UPDATE user SET password&#x3D;PASSWORD(&quot;new password&quot;) WHERE user&#x3D;&#39;username&#39;;</span><br><span class="line"></span><br><span class="line">示例5.7之后的版本:</span><br><span class="line">UPDATE user SET password&#x3D;PASSWORD(&quot;Ikingtec909&quot;) WHERE user&#x3D;&#39;root&#39;;</span><br><span class="line"></span><br><span class="line">5.7之前的版本:</span><br><span class="line">update mysql.user set authentication_string&#x3D;password(&#39;Ikingtec909&#39;) where user&#x3D;&#39;root&#39;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">mysql&gt; quit;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#刷新权限</span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line">#修改配置文件设置数据写入格式utf-8</span><br><span class="line">vim &#x2F;etc&#x2F;mysql&#x2F;my.cnf</span><br><span class="line"></span><br><span class="line">加入下列配置</span><br><span class="line">[client]</span><br><span class="line">default_character_set&#x3D;utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line">default_character_set&#x3D;utf8</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">character_set_server&#x3D;utf8</span><br><span class="line"></span><br><span class="line">#修改配置文件远程访问</span><br><span class="line"></span><br><span class="line">vim &#x2F;etc&#x2F;mysql&#x2F;mysql.conf.d&#x2F;mysqld.cnf</span><br><span class="line"></span><br><span class="line">bind-address&#x3D; 0.0.0.0</span><br></pre></td></tr></table></figure>

<h4 id="4-5-重启mysql-确保防火墙允许-3306-端口开启"><a href="#4-5-重启mysql-确保防火墙允许-3306-端口开启" class="headerlink" title="4.5.重启mysql,  确保防火墙允许 3306 端口开启"></a>4.5.重启mysql,  <strong>确保防火墙允许 3306 端口开启</strong></h4><h4 id="4-6-mysq主从架构"><a href="#4-6-mysq主从架构" class="headerlink" title="4.6.mysq主从架构"></a>4.6.mysq主从架构</h4><h5 id="4-6-1-mysql主服务器配置"><a href="#4-6-1-mysql主服务器配置" class="headerlink" title="4.6.1.mysql主服务器配置"></a>4.6.1.mysql主服务器配置</h5><p>增加下列配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">#这是数据库ID,此ID是唯一的，主库默认为1，其他从库以此ID进行递增，ID值不能重复，否则会同步出错；</span><br><span class="line">server-id &#x3D; 1</span><br><span class="line">#默认 binlog日志存放路径，mysql-bin 日志名称</span><br><span class="line">#二进制日志文件，开启binlog,此项为必填项，否则不能同步数据；</span><br><span class="line">log-bin&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql-bin</span><br><span class="line">#日志中会记录成每一行数据被修改的形式</span><br><span class="line">#binlog日志格式</span><br><span class="line">binlog-format&#x3D;ROW</span><br><span class="line">#需要同步的数据库，如果需要同步多个数据库；则继续添加此项</span><br><span class="line">binlog-do-db &#x3D; ik_test_DB</span><br><span class="line"># binlog-do-db &#x3D; slaveDB1</span><br><span class="line"># binlog-do-db &#x3D; slaveDB2</span><br><span class="line">#不需要同步的数据库</span><br><span class="line">binlog-ignore-db &#x3D; mysql</span><br></pre></td></tr></table></figure>

<p>配置完成后数据库需要重启,然后查看binlog日志是否开启</p>
<p> show variables like ‘log_bin’; </p>
<h5 id="4-6-2-mysql从服务器配置"><a href="#4-6-2-mysql从服务器配置" class="headerlink" title="4.6.2.mysql从服务器配置"></a>4.6.2.mysql从服务器配置</h5><p>增加下列配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line"></span><br><span class="line">#从数据库配置</span><br><span class="line">server-id&#x3D;2</span><br><span class="line">relay-log&#x3D;mysql-relay</span><br><span class="line">#开启binlog,此项为必填项，否则不能同步数据；</span><br><span class="line">log-bin&#x3D;&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;mysql-bin</span><br><span class="line">#binlog格式</span><br><span class="line">binlog-format&#x3D;ROW</span><br><span class="line">#此参数的含义是：slave数据库将二进制日志写入自己的binlog中</span><br><span class="line">log_slave_updates&#x3D;1</span><br><span class="line"></span><br><span class="line">#监控的数据库</span><br><span class="line">binlog-do-db&#x3D;ik_test_DB</span><br></pre></td></tr></table></figure>

<p>数据库重启:</p>
<p>service mysql restart</p>
<h5 id="4-6-3-在主服务器建立账户-并授权从服务器"><a href="#4-6-3-在主服务器建立账户-并授权从服务器" class="headerlink" title="4.6.3.在主服务器建立账户,并授权从服务器"></a>4.6.3.在主服务器建立账户,并授权从服务器</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GRANT REPLICATION SLAVE ON *.* TO &#39;slave&#39;@&#39;从机器数据库IP&#39; IDENTIFIED BY &#39;123456&#39;</span><br></pre></td></tr></table></figure>

<h5 id="4-6-4-主服务器执行执行show-master-status"><a href="#4-6-4-主服务器执行执行show-master-status" class="headerlink" title="4.6.4.主服务器执行执行show master status"></a>4.6.4.主服务器执行执行show master status</h5><p>show master status</p>
<p>1.记录下File和Position的值</p>
<p>2.执行完此步骤后不要再操作主服务器MYSQL，防止主服务器状态值变化</p>
<h5 id="4-6-5-从服务器复制主服务器数据"><a href="#4-6-5-从服务器复制主服务器数据" class="headerlink" title="4.6.5.从服务器复制主服务器数据"></a>4.6.5.从服务器复制主服务器数据</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST&#x3D;&#39;主机IP&#39;,MASTER_USER&#x3D;&#39;用户名&#39;,MASTER_PASSWORD&#x3D;&#39;密码&#39;,MASTER_LOG_FILE&#x3D;&#39;File名字&#39;,MASTER_LOG_POS&#x3D;Position数字</span><br><span class="line"></span><br><span class="line">CHANGE MASTER TO MASTER_HOST&#x3D;&#39;172.26.69.85&#39;,MASTER_USER&#x3D;&#39;slave&#39;,MASTER_PASSWORD&#x3D;&#39;slave123&#39;,MASTER_LOG_FILE&#x3D;&#39;mysql-bin.000001&#39;,MASTER_LOG_POS&#x3D;441;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CHANGE MASTER TO MASTER_HOST&#x3D;&#39;172.26.69.85&#39;,MASTER_USER&#x3D;&#39;slave&#39;,MASTER_PASSWORD&#x3D;&#39;Ikingtec909&#39;,MASTER_LOG_FILE&#x3D;&#39;mysql-bin.000005&#39;,MASTER_LOG_POS&#x3D;2232;</span><br></pre></td></tr></table></figure>

<h5 id="4-6-6-从服务器启动slave"><a href="#4-6-6-从服务器启动slave" class="headerlink" title="4.6.6.从服务器启动slave"></a>4.6.6.从服务器启动slave</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start slave</span><br></pre></td></tr></table></figure>

<h5 id="4-6-7-查看slave状态"><a href="#4-6-7-查看slave状态" class="headerlink" title="4.6.7.查看slave状态"></a>4.6.7.查看slave状态</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G;</span><br><span class="line">下面两个参数都是Yes，则说明主从配置成功！</span><br><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<h5 id="4-6-8-主机新建库、新建表、insert记录，从机复制"><a href="#4-6-8-主机新建库、新建表、insert记录，从机复制" class="headerlink" title="4.6.8.主机新建库、新建表、insert记录，从机复制"></a>4.6.8.主机新建库、新建表、insert记录，从机复制</h5><h5 id="4-6-9-停止从机复制功能"><a href="#4-6-9-停止从机复制功能" class="headerlink" title="4.6.9.停止从机复制功能"></a>4.6.9.停止从机复制功能</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop slave</span><br></pre></td></tr></table></figure>

<h4 id="4-7-在从服务器加canal"><a href="#4-7-在从服务器加canal" class="headerlink" title="4.7.在从服务器加canal"></a>4.7.在从服务器加canal</h4><h5 id="4-7-1-新增一个用户权限"><a href="#4-7-1-新增一个用户权限" class="headerlink" title="4.7.1.新增一个用户权限"></a>4.7.1.新增一个用户权限</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &#39;canal&#39;@&#39;%&#39; IDENTIFIED </span><br><span class="line">BY &#39;canal&#39; ;</span><br></pre></td></tr></table></figure>



<h5 id="4-7-2-增加配置-这些配置在上述操作中已经添加"><a href="#4-7-2-增加配置-这些配置在上述操作中已经添加" class="headerlink" title="4.7.2.增加配置(这些配置在上述操作中已经添加)"></a>4.7.2.增加配置(这些配置在上述操作中已经添加)</h5><p>增加下列配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#binlog格式</span><br><span class="line">binlog-format&#x3D;ROW</span><br><span class="line">#此参数的含义是：slave数据库将二进制日志写入自己的binlog中</span><br><span class="line">log_slave_updates&#x3D;1</span><br><span class="line"></span><br><span class="line">#监控的数据库</span><br><span class="line">binlog-do-db&#x3D;ik_test_DB</span><br></pre></td></tr></table></figure>

<h5 id="4-7-3-重启mysql"><a href="#4-7-3-重启mysql" class="headerlink" title="4.7.3.重启mysql"></a>4.7.3.重启mysql</h5><p>service mysql restart</p>
<h5 id="4-7-4-安装canal"><a href="#4-7-4-安装canal" class="headerlink" title="4.7.4.安装canal"></a>4.7.4.安装canal</h5><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/releases">https://github.com/alibaba/canal/releases</a></p>
<h5 id="4-7-5-修改canal配置"><a href="#4-7-5-修改canal配置" class="headerlink" title="4.7.5.修改canal配置"></a>4.7.5.修改canal配置</h5><p>vim conf/canal.properties</p>
<p>这个文件是canal的基本通用配置，主要关心一下端口号，不改的话默认就是11111</p>
<p> vim conf/example/instance.properties</p>
<p>instance.properties是针对要追踪的mysql的实例配置</p>
<p>修改下列配置:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#不能与mysql的server-id重复</span><br><span class="line">canal.instance.mysql.slaveId&#x3D;20</span><br><span class="line"></span><br><span class="line"># position info,配置mysqlip和端口号</span><br><span class="line">canal.instance.master.address&#x3D;172.26.69.84:3306</span><br><span class="line"></span><br><span class="line"># username&#x2F;password</span><br><span class="line">canal.instance.dbUsername&#x3D;canal</span><br><span class="line">canal.instance.dbPassword&#x3D;canal</span><br><span class="line">canal.instance.connectionCharset &#x3D; UTF-8</span><br><span class="line"></span><br><span class="line">#设置监听的库</span><br><span class="line">canal.instance.defaultDatabaseName &#x3D;ik_test_DB</span><br></pre></td></tr></table></figure>



<h5 id="4-7-6-启动canal"><a href="#4-7-6-启动canal" class="headerlink" title="4.7.6.启动canal"></a>4.7.6.启动canal</h5><p>/bin/startup.sh</p>
<p>jps   =&gt; CanalLauncher进程</p>
<p>如果起动不成功,排查问题参考</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.需要修改canal.properties配置，但是官网没有讲解。（大概率）进入canal解压文件 ，编辑conf&#x2F;canal.properties文件</span><br><span class="line">vim conf&#x2F;canal.properties</span><br><span class="line">有这么一行</span><br><span class="line">canal.instance.parser.parallelThreadSize &#x3D; 16</span><br><span class="line">默认是被注释掉的，需要打开注释,然后重启canal</span><br><span class="line">cd bin</span><br><span class="line">.&#x2F;restart.sh</span><br><span class="line">这种是第一次配置时，大概率碰到的情况。</span><br></pre></td></tr></table></figure>

<h5 id="4-7-6-测试"><a href="#4-7-6-测试" class="headerlink" title="4.7.6.测试"></a>4.7.6.测试</h5><p>参考地址:</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/wiki/QuickStart">https://github.com/alibaba/canal/wiki/QuickStart</a></p>
<p> <a target="_blank" rel="noopener" href="https://github.com/alibaba/canal/wiki/ClientExample">https://github.com/alibaba/canal/wiki/ClientExample</a> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2018/11/01/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE-ubuntu/" data-id="ckw5znxwc000bw9gh7p6octdv" class="article-share-link">
        分享
      </a>
      
    </footer>

  </div>

  

  

</article>
    
  </article>
  

  
  <nav class="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
  </nav>
  
</section>
</div>
    <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
  <li><i class="fe fe-bar-chart"></i> <span id="busuanzi_value_site_pv"></span></li>
  
  <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>个人博客 &copy; 2021</li>
      
        <li>ZHWANGART</li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="个人博客"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">Home</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">Archives</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">Gallery</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">About</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        搜索
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/copybtn.js"></script>






<script src="/js/ocean.js"></script>

</body>

</html>